<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ingl√™s R√°pido ‚Äî Super Aula</title>
  <style>
    :root{
      --bg:#020617;
      --card:#0b1226;
      --stroke:#1f2a44;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --good:#22c55e;
      --bad:#ef4444;
      --blue:#3b82f6;
      --yel:#f59e0b;
      --shadow: 0 14px 36px rgba(0,0,0,.5);
      --r: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background:
        radial-gradient(1100px 700px at 20% 0%, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(900px 650px at 85% 10%, rgba(34,197,94,.18), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    .app{max-width:1080px;margin:0 auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg,var(--blue),var(--good));
      box-shadow:var(--shadow);
    }
    h1{margin:0;font-size:16px}
    .sub{margin-top:2px;color:var(--muted);font-size:12px}
    nav{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    button{
      border:1px solid var(--stroke);
      background: rgba(11,18,38,.65);
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      cursor:pointer;
      font-weight:800;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    button:active{transform:scale(.98)}
    button.primary{
      border:none;
      background:linear-gradient(135deg,var(--blue),var(--good));
      color:#06111f;
    }
    button.danger{
      border:none;
      background:linear-gradient(135deg,var(--bad),#fb7185);
      color:#1a0a0a;
    }
    button.active{
      border-color: rgba(34,197,94,.65);
      background: rgba(34,197,94,.12);
    }
    .card{
      background: rgba(11,18,38,.55);
      border:1px solid var(--stroke);
      border-radius:var(--r);
      padding:14px;
      box-shadow:var(--shadow);
    }
    .grid{display:grid;gap:12px}
    @media(min-width:900px){ .grid.two{grid-template-columns: 1.35fr .65fr;} }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .space{justify-content:space-between}
    .pill{
      display:inline-flex;align-items:center;gap:6px;
      padding:5px 10px;border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.35);
      color:var(--muted);
      font-size:12px;
    }
    .pill b{color:var(--text)}
    .muted{color:var(--muted);font-size:12px;line-height:1.35}
    .h2{font-size:15px;font-weight:900;margin:0}
    .h3{font-size:13px;font-weight:900;margin:0}
    .screen{display:none}
    .screen.active{display:block}
    .divider{height:1px;background:rgba(148,163,184,.18);margin:10px 0}
    .progress{height:10px;border-radius:999px;overflow:hidden;border:1px solid var(--stroke);background:rgba(2,6,23,.35)}
    .progress>div{height:100%;width:0%;background:linear-gradient(90deg,var(--good),var(--blue));transition:width .2s ease}
    .hero{
      border-radius:var(--r);
      border:1px solid rgba(148,163,184,.18);
      background:
        radial-gradient(800px 420px at 15% 15%, rgba(59,130,246,.25), transparent 60%),
        radial-gradient(650px 420px at 85% 10%, rgba(34,197,94,.16), transparent 60%),
        rgba(2,6,23,.25);
      padding:16px;
    }
    .big{font-size:18px;font-weight:950;margin:6px 0 0;line-height:1.2}
    .episode{
      margin-top:10px;
      border-radius:var(--r);
      border:1px dashed rgba(148,163,184,.25);
      background:rgba(2,6,23,.25);
      padding:12px;
    }
    .line{
      display:flex;gap:10px;align-items:flex-start;
      padding:10px;border-radius:14px;
      border:1px solid rgba(148,163,184,.15);
      background:rgba(11,18,38,.35);
      margin-top:8px;
    }
    .avatar{
      width:34px;height:34px;border-radius:12px;
      background:rgba(59,130,246,.18);
      border:1px solid rgba(59,130,246,.30);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
    }
    .avatar.you{background:rgba(34,197,94,.16);border-color:rgba(34,197,94,.30)}
    .en{
      font-size:15px;font-weight:900;
      margin:0;
    }
    .pt{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .kbd{
      font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:12px;color:var(--muted);
      border:1px solid var(--stroke);
      padding:2px 8px;border-radius:999px;
      background:rgba(2,6,23,.35);
    }
    .panel{
      border-radius:var(--r);
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.35);
      padding:12px;
      margin-top:10px;
    }
    .token{
      padding:2px 8px;border-radius:999px;border:1px solid var(--stroke);
      display:inline-flex;gap:6px;align-items:center;
      margin:3px 4px 0 0;font-size:12px;color:var(--muted);
      background:rgba(11,18,38,.45);
    }
    .token b{color:var(--text)}
    .token.s{border-color:rgba(59,130,246,.35)}
    .token.v{border-color:rgba(34,197,94,.35)}
    .token.o{border-color:rgba(245,158,11,.35)}
    input[type="text"], textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(2,6,23,.35);
      color:var(--text);
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    .opts{display:grid;gap:8px;margin-top:10px}
    .opt{
      text-align:left;border-radius:999px;
      padding:10px 12px;border:1px solid var(--stroke);
      background:rgba(11,18,38,.55);
      font-weight:850;cursor:pointer;
    }
    .opt:hover{border-color:rgba(96,165,250,.55)}
    .opt.correct{border-color:rgba(34,197,94,.75);background:rgba(34,197,94,.12)}
    .opt.wrong{border-color:rgba(239,68,68,.75);background:rgba(239,68,68,.12)}
    .feedback{
      margin-top:10px;padding:10px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(11,18,38,.45);
      line-height:1.35;font-size:13px;
    }
    .feedback.good{border-color:rgba(34,197,94,.55)}
    .feedback.bad{border-color:rgba(239,68,68,.55)}
    .flash{
      position:fixed;inset:0;pointer-events:none;
      opacity:0;transition:opacity .14s ease;
    }
    .flash.good{background:rgba(34,197,94,.14)}
    .flash.bad{background:rgba(239,68,68,.14)}
    .flash.show{opacity:1}
    .mini{font-size:11px;color:var(--muted)}
    .modeTag{
      display:inline-flex;align-items:center;gap:6px;
      padding:5px 10px;border-radius:999px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.25);
      font-size:12px;color:var(--muted);
    }
  </style>
</head>
<body>
  <div class="flash good" id="flashGood"></div>
  <div class="flash bad" id="flashBad"></div>

  <div class="app">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Ingl√™s R√°pido ‚Äî Super Aula (Story + Speaking)</h1>
          <div class="sub">Aula din√¢mica ‚Ä¢ sem repeti√ß√£o ‚Ä¢ feedback em PT-BR ‚Ä¢ A1 ‚Üí C1</div>
        </div>
      </div>
      <nav>
        <button id="tabHome" class="active">In√≠cio</button>
        <button id="tabLesson">Aula</button>
        <button id="tabCoach">Coach</button>
        <button id="tabSettings">‚öôÔ∏è</button>
      </nav>
    </header>

    <!-- HOME -->
    <section id="home" class="screen active">
      <div class="grid two">
        <div class="card hero">
          <div class="row space">
            <div>
              <div class="modeTag">üî• Aula ‚Äúepis√≥dio‚Äù (5‚Äì12 min) ‚Ä¢ A1</div>
              <div class="big">Voc√™ vai aprender a se apresentar e falar sua rotina ‚Äî no modo jogo.</div>
              <div class="muted" style="margin-top:6px;">
                Estrutura: <b>Story</b> ‚Üí <b>Listening</b> ‚Üí <b>Ditado</b> ‚Üí <b>Escolha resposta</b> ‚Üí <b>Speaking</b> ‚Üí <b>Grammar fix</b> ‚Üí <b>Final boss</b>.
              </div>
            </div>
            <button class="primary" id="btnStart">Come√ßar a Super Aula</button>
          </div>

          <div class="divider"></div>

          <div class="row" style="gap:8px">
            <span class="pill">XP <b id="xp">0</b></span>
            <span class="pill">Streak <b id="streak">0</b> üî•</span>
            <span class="pill">N√≠vel <b id="level">A1</b></span>
            <span class="pill">Sem repeti√ß√£o <b>ON</b></span>
          </div>

          <div style="margin-top:10px">
            <div class="row space">
              <div class="muted">Progresso da aula</div>
              <div class="kbd"><span id="stepN">0</span>/7</div>
            </div>
            <div class="progress" style="margin-top:6px"><div id="bar"></div></div>
          </div>

          <div class="episode">
            <div class="h3">Epis√≥dio 1: ‚ÄúFirst day at work‚Äù</div>
            <div class="muted" style="margin-top:6px">
              Voc√™ chega no trabalho e precisa: dizer ‚Äúoi‚Äù, se apresentar, falar o que voc√™ faz e fazer uma pergunta simples.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="h2">O que faz essa aula ser diferente</div>
          <ul class="muted" style="margin-top:10px; padding-left:18px">
            <li><b>Errou?</b> troca o exerc√≠cio na hora (mesma meta, outro cen√°rio).</li>
            <li><b>Speaking</b> com reconhecimento de voz (se dispon√≠vel no navegador).</li>
            <li><b>Feedback did√°tico</b> (em portugu√™s) focando no seu erro.</li>
            <li><b>Sem repeti√ß√£o</b> (IDs √∫nicos por sess√£o).</li>
            <li><b>Grammar sem chatice</b>: 1 regra + 2 exemplos + pr√°tica imediata.</li>
          </ul>

          <div class="divider"></div>

          <div class="h3">Atalhos</div>
          <div class="muted" style="margin-top:8px">
            üîä ‚ÄúOuvir‚Äù sempre dispon√≠vel ‚Ä¢ üé§ ‚ÄúFalar‚Äù quando o modo speaking aparece
          </div>

          <div class="divider"></div>

          <button id="btnJumpLesson" class="primary">Abrir Aula</button>
        </div>
      </div>
    </section>

    <!-- LESSON -->
    <section id="lesson" class="screen">
      <div class="card">
        <div class="row space">
          <div>
            <div class="h2" id="lessonTitle">Super Aula ‚Ä¢ Epis√≥dio 1</div>
            <div class="muted" id="lessonSub">A1 ‚Ä¢ Apresenta√ß√£o + rotina</div>
          </div>
          <div class="row">
            <button id="btnHear" class="secondary">üîä Ouvir</button>
            <button id="btnSkip" class="secondary">Trocar</button>
            <button id="btnExit" class="secondary">Voltar</button>
          </div>
        </div>

        <div class="panel" id="stage"></div>

        <div class="divider"></div>

        <div class="row space">
          <div class="row" style="gap:8px">
            <span class="pill">Etapa <b id="stepLabel">‚Äî</b></span>
            <span class="pill">XP +<b id="xpRun">0</b></span>
            <span class="pill">Acertos <b id="hits">0</b></span>
            <span class="pill">Erros <b id="miss">0</b></span>
          </div>
          <button class="danger" id="btnEnd">Encerrar Aula</button>
        </div>
      </div>
    </section>

    <!-- COACH -->
    <section id="coach" class="screen">
      <div class="card">
        <div class="row space">
          <div>
            <div class="h2">Coach (mem√≥ria do seu aprendizado)</div>
            <div class="muted">Aqui ficam suas frases-chave e seus erros mais comuns para corrigir r√°pido.</div>
          </div>
          <button id="btnBackCoach" class="secondary">Voltar</button>
        </div>

        <div class="divider"></div>

        <div class="h3">Frases que voc√™ ‚Äúdomina‚Äù (salvas)</div>
        <ul id="saved" class="muted" style="margin-top:8px;padding-left:18px"></ul>

        <div class="divider"></div>

        <div class="h3">Erros comuns detectados</div>
        <div id="commonErrors" class="muted" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="screen">
      <div class="card">
        <div class="row space">
          <div>
            <div class="h2">Configura√ß√µes</div>
            <div class="muted">TTS, microfone e reset do banco (sem repeti√ß√£o).</div>
          </div>
          <button id="btnBackSettings" class="secondary">Voltar</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="btnTestVoice" class="secondary">Testar voz</button>
          <button id="btnStopVoice" class="secondary">Parar voz</button>
          <span class="pill">Voz <b id="voiceName">auto</b></span>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="btnResetSession" class="secondary">Reset banco da sess√£o</button>
          <button id="btnResetAll" class="danger">Reset total (tudo)</button>
        </div>

        <div class="divider"></div>

        <div class="muted">
          <b>Importante:</b> no Android/Chrome, o microfone costuma funcionar bem no modo speaking.  
          Se n√£o aparecer, o app troca automaticamente para digita√ß√£o.
        </div>
      </div>
    </section>
  </div>

<script>
(() => {
  // ============================
  // UTIL
  // ============================
  const $ = (id)=>document.getElementById(id);
  const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
  const shuffle = (arr)=>{
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]]=[a[j],a[i]];
    }
    return a;
  };
  const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
  const norm = (s)=>(s||"")
    .toLowerCase()
    .replace(/[‚Äô']/g,"'")
    .replace(/[^a-z0-9\s\-\?]/g,"")
    .replace(/\s+/g," ")
    .trim();
  const todayKey = ()=>{
    const d=new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  };

  // ============================
  // STORAGE
  // ============================
  const KEY="super_aula_v1";
  const store={
    get(k,f){try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch{return f}},
    set(k,v){localStorage.setItem(k,JSON.stringify(v))}
  };
  const DEFAULT={
    xp:0, streak:0, lastDay:null,
    saved:[],
    commonErrors:{}, // key -> count
    usedIds:[], // session no-repeat
  };
  let state=store.get(KEY,DEFAULT);
  state={...DEFAULT,...state};
  state.saved=state.saved||[];
  state.commonErrors=state.commonErrors||{};
  state.usedIds=state.usedIds||[];

  // streak
  const tk=todayKey();
  if(!state.lastDay){
    state.lastDay=tk;
  }else if(state.lastDay!==tk){
    const last=new Date(state.lastDay+"T00:00:00");
    const now=new Date(tk+"T00:00:00");
    const diff=Math.round((now-last)/(1000*60*60*24));
    if(diff===1) state.streak=(state.streak||0)+1;
    else state.streak=0;
    state.lastDay=tk;
  }

  // ============================
  // AUDIO (SFX + TTS)
  // ============================
  let audioCtx=null;
  function ensureAudio(){
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    if(audioCtx.state==="suspended") audioCtx.resume().catch(()=>{});
  }
  function beep(type){
    try{
      ensureAudio();
      const now=audioCtx.currentTime;
      const o=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      if(type==="good"){
        o.type="sine";
        o.frequency.setValueAtTime(880,now);
        o.frequency.exponentialRampToValueAtTime(1320,now+0.12);
        g.gain.setValueAtTime(0.0001,now);
        g.gain.exponentialRampToValueAtTime(0.28,now+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001,now+0.18);
        o.start(now); o.stop(now+0.2);
      }else{
        o.type="square";
        o.frequency.setValueAtTime(160,now);
        o.frequency.exponentialRampToValueAtTime(90,now+0.12);
        g.gain.setValueAtTime(0.0001,now);
        g.gain.exponentialRampToValueAtTime(0.25,now+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001,now+0.22);
        o.start(now); o.stop(now+0.24);
      }
    }catch{}
  }
  function flash(type){
    const el = type==="good"?$("flashGood"):$("flashBad");
    el.classList.add("show");
    setTimeout(()=>el.classList.remove("show"),140);
  }

  let voices=[];
  function loadVoices(){
    voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
    const best =
      voices.find(v=>/en(-|_)us/i.test(v.lang)) ||
      voices.find(v=>/^en/i.test(v.lang)) ||
      voices[0];
    $("voiceName").textContent = best ? `${best.name} (${best.lang})` : "indispon√≠vel";
  }
  if(window.speechSynthesis){
    window.speechSynthesis.onvoiceschanged=loadVoices;
    loadVoices();
  }
  function speak(text){
    if(!window.speechSynthesis) return;
    try{
      window.speechSynthesis.cancel();
      const u=new SpeechSynthesisUtterance(text);
      const best =
        voices.find(v=>/en(-|_)us/i.test(v.lang)) ||
        voices.find(v=>/^en/i.test(v.lang));
      if(best) u.voice=best;
      u.lang=best?best.lang:"en-US";
      u.rate=0.95; u.pitch=1.0;
      window.speechSynthesis.speak(u);
    }catch{}
  }
  function stopSpeak(){ try{window.speechSynthesis && window.speechSynthesis.cancel()}catch{} }

  // ============================
  // SPEECH RECOGNITION (Speaking)
  // ============================
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  function canSpeak(){ return !!SR; }

  function listenOnce(lang="en-US", timeoutMs=6500){
    return new Promise((resolve)=>{
      if(!SR){ resolve({ok:false, text:"", reason:"SR_NOT_AVAILABLE"}); return; }
      const rec = new SR();
      rec.lang = lang;
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      let done=false;

      const timer=setTimeout(()=>{
        if(done) return;
        done=true;
        try{ rec.stop(); }catch{}
        resolve({ok:false, text:"", reason:"TIMEOUT"});
      }, timeoutMs);

      rec.onresult = (e)=>{
        if(done) return;
        done=true;
        clearTimeout(timer);
        const t = (e.results && e.results[0] && e.results[0][0] && e.results[0][0].transcript) ? e.results[0][0].transcript : "";
        resolve({ok:true, text:t, reason:"OK"});
      };
      rec.onerror = ()=>{
        if(done) return;
        done=true;
        clearTimeout(timer);
        resolve({ok:false, text:"", reason:"ERROR"});
      };
      try{ rec.start(); }catch{ clearTimeout(timer); resolve({ok:false,text:"",reason:"START_FAIL"}); }
    });
  }

  // ============================
  // EXERCISE ENGINE (NO REPEAT)
  // ============================
  // Episode theme: Work (meeting)
  const SUBJECTS = ["I","You","We","They","He","She"];
  const ROLES = ["trainer","operator","student","supervisor","engineer","technician"];
  const TIMES = ["every day","in the morning","after work","on Fridays","at night"];
  const OBJECTS = ["a meeting","English","this checklist","the schedule","my routine","a new module"];
  const PLACES = ["at work","at the office","in the factory","at home","in the training room"];

  function makeId(parts){ return parts.map(x=>String(x).toLowerCase().replace(/\s+/g,"_")).join("|"); }

  // Mini ‚ÄúIA-like‚Äù feedback: detect typical beginner mistakes
  function diagnose(expected, got){
    const e = norm(expected);
    const g = norm(got);

    if(!g) return {key:"EMPTY", msg:"Voc√™ n√£o respondeu. Tenta de novo ‚Äî sem medo."};

    // Verb to be: am/is/are
    if(e.includes(" i am ") || e.startsWith("i am")){
      if(g.startsWith("i is") || g.startsWith("i are")) return {key:"BE_I", msg:'Para "I", use **am**: "I am ..." (n√£o "I is/are").'};
    }
    if(e.includes(" he is ") || e.startsWith("he is") || e.includes(" she is ") || e.startsWith("she is")){
      if(g.includes("he are") || g.includes("he am") || g.includes("she are") || g.includes("she am"))
        return {key:"BE_HE_SHE", msg:'Para "he/she", use **is**: "He is / She is".'};
    }
    if(e.includes(" we are ") || e.startsWith("we are") || e.includes(" they are ") || e.startsWith("they are") || e.includes(" you are ") || e.startsWith("you are")){
      if(g.includes("we is") || g.includes("they is") || g.includes("you is"))
        return {key:"BE_WE_THEY", msg:'Para "you/we/they", use **are**: "You are / We are / They are".'};
    }

    // do/does
    if(e.startsWith("does ") && g.startsWith("do ")) return {key:"DOES", msg:'Com **he/she/it**, a pergunta usa **Does** (n√£o Do).'};
    if(e.startsWith("do ") && g.startsWith("does ")) return {key:"DO", msg:'Com **I/you/we/they**, a pergunta usa **Do** (n√£o Does).'};
    if(e.includes(" does not ") && g.includes(" do not ") && (e.includes("he")||e.includes("she"))) return {key:"NEG_DOES", msg:'Com **he/she/it**, a negativa √© **does not**.'};

    // missing article a/an
    if(e.includes(" a ") && !g.includes(" a ")) return {key:"ARTICLE_A", msg:'Faltou o artigo **a** em algum lugar (ex.: "a meeting", "a trainer").'};

    // order (SVO)
    const parts = e.split(" ");
    if(parts.length>=3){
      const subj = parts[0];
      if(g.includes(parts[1]+" "+subj)) return {key:"ORDER", msg:'Ordem comum: **Sujeito + Verbo + Complemento**. Ex.: "I work at..."'};
    }

    return {key:"GENERIC", msg:"Quase! Ajusta a estrutura e tenta novamente. Eu vou trocar o exerc√≠cio pra fixar melhor."};
  }

  function addCommonError(key){
    state.commonErrors[key] = (state.commonErrors[key]||0) + 1;
  }

  // Exercise factory ‚Äî each step has multiple variants; no repetition
  function nextUniqueFrom(list){
    const candidates = list.filter(x => !state.usedIds.includes(x.id));
    if(!candidates.length){
      // reset session bank automatically
      state.usedIds = [];
      store.set(KEY,state);
      return pick(list);
    }
    return pick(candidates);
  }

  // Step templates (A1)
  function genStory(){
    // story is fixed but we‚Äôll still track ID
    return {
      id: "STEP1_STORY",
      type:"STORY",
      title:"1) Story ‚Äî contexto do epis√≥dio",
      tts:"Hello! Welcome. Let's practice English.",
      lines:[
        {who:"Alex", en:"Hi! Welcome to the training room.", pt:"Oi! Bem-vindo √† sala de treinamento."},
        {who:"You", en:"Hi! I'm Claudio. I'm new here.", pt:"Oi! Eu sou Cl√°udio. Sou novo aqui."},
        {who:"Alex", en:"Nice to meet you. What do you do?", pt:"Prazer em conhecer voc√™. O que voc√™ faz?"},
      ]
    };
  }

  function genListening(){
    const subj = pick(["I","We","They"]);
    const role = pick(ROLES);
    const time = pick(TIMES);
    const place = pick(PLACES);
    const en = `${subj} am a ${role}.`.replace("We am","We are").replace("They am","They are");
    const en2 = `${subj} practice English ${time} ${place}.`;
    const tts = `${en} ${en2}`;
    const id = makeId(["STEP2_LISTEN", subj, role, time, place]);

    return {
      id, type:"LISTEN",
      title:"2) Listening ‚Äî ou√ßa e entenda",
      promptPT:"Ou√ßa 2 frases e escolha a ideia correta.",
      audioText: tts,
      questionPT:"Qual ideia est√° correta?",
      options: shuffle([
        {t:`${subj} √© um(a) ${role} e pratica ingl√™s.`, ok:true},
        {t:`${subj} n√£o trabalha e n√£o estuda ingl√™s.`, ok:false},
        {t:`${subj} est√° no aeroporto agora.`, ok:false},
        {t:`${subj} odeia ingl√™s.`, ok:false},
      ]),
      explainPT:"Voc√™ precisa primeiro entender o sentido geral, sem travar em palavra por palavra."
    };
  }

  function genDictation(){
    const subj = pick(["I","He","She"]);
    const obj = pick(OBJECTS);
    const place = pick(["at work","at home","in the training room"]);
    let en = `${subj} ${subj==="I"?"practice":"practices"} ${obj} ${place}.`;
    if(obj.startsWith("a ")) en = en; // keep
    const id = makeId(["STEP3_DICT", subj, obj, place]);
    return {
      id, type:"DICTATION",
      title:"3) Ditado ‚Äî escreva o que ouviu",
      promptPT:"Clique em üîä para ouvir. Depois, digite a frase em ingl√™s.",
      expected: en,
      tts: en,
      hintPT:'Dica: "I practice" / "He practices". Aten√ß√£o no "s".'
    };
  }

  function genChooseResponse(){
    const subj = pick(["I","He","She"]);
    const role = pick(ROLES);
    const enQ = `What do you do?`;
    const correct = `I am a ${role}.`;
    const wrong1 = `I have ${role}.`;
    const wrong2 = `I am ${role}.`; // acceptable-ish but keep as distractor
    const wrong3 = `I is a ${role}.`;

    const options = shuffle([
      {t:correct, ok:true},
      {t:wrong1, ok:false},
      {t:wrong2, ok:false},
      {t:wrong3, ok:false},
    ]);

    const id = makeId(["STEP4_CHOOSE", role]);
    return {
      id, type:"CHOOSE",
      title:"4) Di√°logo ‚Äî escolha sua resposta",
      promptPT:"Voc√™ est√° falando com o colega. Escolha a melhor resposta.",
      scene:[
        {who:"Alex", en:"Nice to meet you.", pt:"Prazer em conhecer voc√™."},
        {who:"Alex", en:enQ, pt:"O que voc√™ faz?"},
      ],
      questionEN: enQ,
      options,
      explainPT:'Padr√£o comum: "I am a/an + profiss√£o".'
    };
  }

  function genSpeaking(){
    const role = pick(ROLES);
    const expected = `I am a ${role}.`;
    const id = makeId(["STEP5_SPEAK", role]);
    return {
      id, type:"SPEAK",
      title:"5) Speaking ‚Äî fale em voz alta",
      promptPT: canSpeak()
        ? "Clique em üé§, fale a frase e eu comparo com o alvo."
        : "Seu navegador n√£o liberou microfone. Use digita√ß√£o (modo fallback).",
      expected,
      tts: expected,
      hintPT:'Dica: pronuncie: "I am a ...". Devagar e claro.'
    };
  }

  function genGrammarFix(){
    // micro-rule: to be + profiss√£o + a/an
    const role = pick(ROLES);
    const a = /^[aeiou]/i.test(role) ? "an" : "a";
    const good = `I am ${a} ${role}.`;
    const bad = `I am ${role}.`;
    const id = makeId(["STEP6_GRAMMAR", role]);

    return {
      id, type:"GRAMMAR",
      title:"6) Grammar fix ‚Äî 1 regra + 1 prova",
      rulePT:"Regra: quando falamos profiss√£o, geralmente usamos **a/an**: ‚ÄúI am a trainer.‚Äù",
      tokens: [
        {k:"S", v:"I", cls:"s", pt:"Sujeito"},
        {k:"V", v:"am", cls:"v", pt:"Verb to be"},
        {k:"O", v:`${a} ${role}`, cls:"o", pt:"Profiss√£o"},
      ],
      challengePT:"Escolha a frase mais correta (mais natural).",
      options: shuffle([
        {t:good, ok:true},
        {t:bad, ok:false},
        {t:`I is ${a} ${role}.`, ok:false},
        {t:`I are ${a} ${role}.`, ok:false},
      ]),
      explainPT:"No come√ßo, isso parece detalhe, mas isso √© o que te faz soar natural."
    };
  }

  function genFinalBoss(){
    const subj = pick(["He","She"]);
    const role = pick(ROLES);
    const time = pick(TIMES);
    const place = pick(PLACES);
    const expected = `${subj} is a ${role}. ${subj} practices English ${time} ${place}.`;
    const id = makeId(["STEP7_BOSS", subj, role, time, place]);

    return {
      id, type:"BOSS",
      title:"7) Final Boss ‚Äî complete o mini desafio",
      promptPT:"Agora voc√™ junta tudo: identidade + rotina. Digite a resposta completa.",
      expected,
      tts: expected,
      hintPT:"Dica: He/She ‚Üí is + practices. Se errar, eu troco o cen√°rio e voc√™ tenta de novo."
    };
  }

  function buildLessonSteps(){
    const steps = [
      genStory(),
      genListening(),
      genDictation(),
      genChooseResponse(),
      genSpeaking(),
      genGrammarFix(),
      genFinalBoss(),
    ];
    // enforce no repeat per session (except story fixed)
    const final = steps.map(s => s.type==="STORY" ? s : nextUniqueFrom([s]));
    final.forEach(s => { if(s.type!=="STORY") state.usedIds.push(s.id); });
    store.set(KEY,state);
    return final;
  }

  // ============================
  // NAV
  // ============================
  const screens = {home:$("home"), lesson:$("lesson"), coach:$("coach"), settings:$("settings")};
  function show(name){
    Object.values(screens).forEach(s=>s.classList.remove("active"));
    screens[name].classList.add("active");

    $("tabHome").classList.toggle("active", name==="home");
    $("tabLesson").classList.toggle("active", name==="lesson");
    $("tabCoach").classList.toggle("active", name==="coach");
    $("tabSettings").classList.toggle("active", name==="settings");
  }
  $("tabHome").onclick=()=>{stopSpeak(); show("home"); renderAll();};
  $("tabLesson").onclick=()=>{stopSpeak(); show("lesson");};
  $("tabCoach").onclick=()=>{stopSpeak(); show("coach"); renderCoach();};
  $("tabSettings").onclick=()=>{stopSpeak(); show("settings");};

  $("btnBackCoach").onclick=()=>show("home");
  $("btnBackSettings").onclick=()=>show("home");
  $("btnJumpLesson").onclick=()=>{show("lesson");};

  // ============================
  // LESSON RUN
  // ============================
  let lessonSteps = [];
  let run = {
    active:false,
    i:0,
    xpRun:0,
    hits:0,
    miss:0,
    current:null
  };

  function renderHUD(){
    $("xp").textContent = state.xp;
    $("streak").textContent = state.streak;
    $("level").textContent = "A1";
    $("xpRun").textContent = run.xpRun;
    $("hits").textContent = run.hits;
    $("miss").textContent = run.miss;

    $("stepN").textContent = run.active ? run.i : 0;
    $("bar").style.width = run.active ? `${(run.i/7)*100}%` : "0%";
    store.set(KEY,state);
  }

  function award(x){
    state.xp += x;
    run.xpRun += x;
    renderHUD();
  }

  function showFeedback(kind, title, msg, tip){
    const box = document.createElement("div");
    box.className = `feedback ${kind}`;
    box.innerHTML = `
      <div style="font-weight:950;margin-bottom:4px">${title}</div>
      <div>${msg}</div>
      ${tip ? `<div class="divider"></div><div class="muted"><b>Dica:</b> ${tip}</div>` : ""}
    `;
    return box;
  }

  function stageHTML(html){
    $("stage").innerHTML = html;
  }

  function stepLabel(){
    return `${run.i}/7`;
  }

  function nextStep(){
    run.i += 1;
    if(run.i > lessonSteps.length){
      stageHTML(`
        <div class="h2">Aula conclu√≠da! ‚úÖ</div>
        <div class="muted" style="margin-top:8px">
          Voc√™ terminou o epis√≥dio. Quer fazer outro? (o sistema pode gerar outro cen√°rio sem repetir).
        </div>
        <div class="divider"></div>
        <div class="row">
          <button class="primary" id="btnAgain">Repetir (novo cen√°rio)</button>
          <button class="secondary" id="btnGoCoach">Ver Coach</button>
          <button class="secondary" id="btnGoHome">Voltar</button>
        </div>
      `);
      $("btnAgain").onclick=()=>startLesson();
      $("btnGoCoach").onclick=()=>{show("coach"); renderCoach();};
      $("btnGoHome").onclick=()=>{show("home"); renderAll();};
      $("stepLabel").textContent = "Fim";
      renderHUD();
      return;
    }

    const s = lessonSteps[run.i-1];
    run.current = s;
    $("stepLabel").textContent = stepLabel();
    renderHUD();
    renderStage(s);
  }

  function replaceCurrentWithSameType(){
    // swap by regenerating only that step type
    const t = run.current.type;
    let newStep = null;
    if(t==="LISTEN") newStep = nextUniqueFrom([genListening()]);
    if(t==="DICTATION") newStep = nextUniqueFrom([genDictation()]);
    if(t==="CHOOSE") newStep = nextUniqueFrom([genChooseResponse()]);
    if(t==="SPEAK") newStep = nextUniqueFrom([genSpeaking()]);
    if(t==="GRAMMAR") newStep = nextUniqueFrom([genGrammarFix()]);
    if(t==="BOSS") newStep = nextUniqueFrom([genFinalBoss()]);
    if(!newStep) return;

    state.usedIds.push(newStep.id);
    store.set(KEY,state);

    lessonSteps[run.i-1] = newStep;
    run.current = newStep;
    renderStage(newStep);
  }

  function renderStage(s){
    // default hear uses s.tts or s.audioText
    if(s.type==="STORY"){
      const lines = s.lines.map(l=>`
        <div class="line">
          <div class="avatar ${l.who==="You"?"you":""}">${l.who==="You"?"Y":"A"}</div>
          <div>
            <p class="en">${l.en}</p>
            <div class="pt">${l.pt}</div>
          </div>
        </div>
      `).join("");
      stageHTML(`
        <div class="h2">${s.title}</div>
        <div class="muted" style="margin-top:6px">Sinta o contexto. Depois a gente treina com exerc√≠cios r√°pidos.</div>
        ${lines}
        <div class="divider"></div>
        <div class="row">
          <button class="primary" id="btnNext">Continuar</button>
        </div>
      `);
      $("btnNext").onclick=()=>{ award(10); run.hits++; beep("good"); flash("good"); nextStep(); };
      return;
    }

    if(s.type==="LISTEN"){
      const opts = s.options.map((o,idx)=>`
        <button class="opt" data-idx="${idx}">${o.t}</button>
      `).join("");
      stageHTML(`
        <div class="h2">${s.title}</div>
        <div class="muted" style="margin-top:6px">${s.promptPT}</div>
        <div class="divider"></div>
        <div class="muted"><b>√Åudio:</b> clique em üîä (topo) e ou√ßa.</div>
        <div class="panel" style="margin-top:10px">
          <div class="h3">${s.questionPT}</div>
          <div class="opts">${opts}</div>
        </div>
        <div id="fb"></div>
      `);
      const buttons = Array.from($("stage").querySelectorAll(".opt"));
      buttons.forEach(btn=>{
        btn.onclick=()=>{
          const idx = Number(btn.getAttribute("data-idx"));
          const ok = s.options[idx].ok;
          buttons.forEach(b=>b.disabled=true);
          if(ok){
            btn.classList.add("correct");
            run.hits++; award(18); beep("good"); flash("good");
            const fb = showFeedback("good","Boa!","Voc√™ entendeu o sentido geral.", s.explainPT);
            $("fb").appendChild(fb);
            setTimeout(()=>nextStep(), 450);
          }else{
            btn.classList.add("wrong");
            run.miss++; award(4); beep("bad"); flash("bad");
            addCommonError("LISTENING_ATTENTION");
            const fb = showFeedback("bad","Ops!","Errou ‚Äî vou trocar por outro listening do mesmo objetivo (sem repetir).", s.explainPT);
            $("fb").appendChild(fb);
            setTimeout(()=>{ replaceCurrentWithSameType(); }, 650);
          }
        };
      });
      return;
    }

    if(s.type==="DICTATION"){
      stageHTML(`
        <div class="h2">${s.title}</div>
        <div class="muted" style="margin-top:6px">${s.promptPT}</div>
        <div class="divider"></div>
        <div class="muted"><b>Alvo:</b> (voc√™ n√£o v√™ a frase; voc√™ ouve)</div>
        <div class="panel">
          <input id="txtDict" type="text" placeholder="Digite aqui..." />
          <div class="mini" style="margin-top:6px">${s.hintPT}</div>
          <div class="row" style="margin-top:10px">
            <button class="primary" id="btnCheck">Verificar</button>
          </div>
          <div id="fb"></div>
        </div>
      `);
      $("btnCheck").onclick=()=>{
        const got = $("txtDict").value;
        const ok = norm(got) === norm(s.expected);
        const fb = $("fb"); fb.innerHTML="";
        if(ok){
          run.hits++; award(22); beep("good"); flash("good");
          if(!state.saved.includes(s.expected)){
            state.saved.unshift(s.expected);
            state.saved = state.saved.slice(0, 25);
          }
          fb.appendChild(showFeedback("good","Perfeito!","Ditado certo. Isso acelera MUITO o listening.", "Agora vamos pro di√°logo."));
          setTimeout(()=>nextStep(), 450);
        }else{
          run.miss++; award(4); beep("bad"); flash("bad");
          const d = diagnose(s.expected, got);
          addCommonError(d.key);
          fb.appendChild(showFeedback("bad","Quase!","Eu vou trocar por outro ditado do mesmo objetivo (sem repetir).", d.msg));
          setTimeout(()=>replaceCurrentWithSameType(), 700);
        }
      };
      return;
    }

    if(s.type==="CHOOSE"){
      const scene = s.scene.map(l=>`
        <div class="line">
          <div class="avatar">${l.who==="Alex"?"A":"Y"}</div>
          <div>
            <p class="en">${l.en}</p>
            <div class="pt">${l.pt}</div>
          </div>
        </div>
      `).join("");
      const opts = s.options.map((o,idx)=>`
        <button class="opt" data-idx="${idx}">${o.t}</button>
      `).join("");
      stageHTML(`
        <div class="h2">${s.title}</div>
        <div class="muted" style="margin-top:6px">${s.promptPT}</div>
        ${scene}
        <div class="panel">
          <div class="h3">Escolha sua resposta:</div>
          <div class="opts">${opts}</div>
          <div id="fb"></div>
        </div>
      `);
      const buttons = Array.from($("stage").querySelectorAll(".opt"));
      buttons.forEach(btn=>{
        btn.onclick=()=>{
          const idx = Number(btn.getAttribute("data-idx"));
          const ok = s.options[idx].ok;
          buttons.forEach(b=>b.disabled=true);
          if(ok){
            btn.classList.add("correct");
            run.hits++; award(18); beep("good"); flash("good");
            $("fb").appendChild(showFeedback("good","Boa resposta!","Isso √© ingl√™s natural para profiss√£o.", s.explainPT));
            setTimeout(()=>nextStep(), 450);
          }else{
            btn.classList.add("wrong");
            run.miss++; award(4); beep("bad"); flash("bad");
            addCommonError("DIALOG_ROLE");
            $("fb").appendChild(showFeedback("bad","Ops!","Errou ‚Äî trocarei por outro di√°logo (mesma meta).", s.explainPT));
            setTimeout(()=>replaceCurrentWithSameType(), 650);
          }
        };
      });
      return;
    }

    if(s.type==="SPEAK"){
      stageHTML(`
        <div class="h2">${s.title}</div>
        <div class="muted" style="margin-top:6px">${s.promptPT}</div>
        <div class="divider"></div>
        <div class="pill">Frase alvo <b>${s.expected}</b></div>
        <div class="panel">
          <div class="row">
            <button class="primary" id="btnMic">üé§ Falar</button>
            <button class="secondary" id="btnFallback">‚úçÔ∏è Digitar</button>
          </div>
          <div id="result" class="muted" style="margin-top:10px"></div>
          <div id="fb"></div>
        </div>
      `);

      const fb = $("fb");
      const res = $("result");

      $("btnMic").onclick = async ()=>{
        fb.innerHTML="";
        res.textContent = "Ouvindo... fale agora.";
        ensureAudio();
        const r = await listenOnce("en-US", 7000);
        if(!r.ok){
          res.textContent = "N√£o consegui usar o microfone aqui. Use o modo digita√ß√£o.";
          addCommonError("MIC_FAIL");
          return;
        }
        res.innerHTML = `<b>Voc√™ falou:</b> ${r.text}`;
        const got = r.text;
        const score = similarity(norm(got), norm(s.expected));
        if(score >= 0.78){
          run.hits++; award(25); beep("good"); flash("good");
          if(!state.saved.includes(s.expected)){
            state.saved.unshift(s.expected);
            state.saved = state.saved.slice(0, 25);
          }
          fb.appendChild(showFeedback("good","Falou bem!","Sua fala ficou bem pr√≥xima do alvo.", "Agora vamos pro grammar fix."));
          setTimeout(()=>nextStep(), 550);
        }else{
          run.miss++; award(4); beep("bad"); flash("bad");
          const d = diagnose(s.expected, got);
          addCommonError(d.key);
          fb.appendChild(showFeedback("bad","Quase!","Vou trocar por outro speaking (mesma meta) pra voc√™ fixar.", d.msg));
          setTimeout(()=>replaceCurrentWithSameType(), 850);
        }
      };

      $("btnFallback").onclick = ()=>{
        fb.innerHTML="";
        stageHTML(`
          <div class="h2">${s.title} (Fallback ‚Äî digita√ß√£o)</div>
          <div class="muted" style="margin-top:6px">Digite a frase alvo (sem microfone).</div>
          <div class="divider"></div>
          <div class="pill">Frase alvo <b>${s.expected}</b></div>
          <div class="panel">
            <input id="txtSpeak" type="text" placeholder="Digite aqui..." />
            <div class="mini" style="margin-top:6px">${s.hintPT}</div>
            <div class="row" style="margin-top:10px">
              <button class="primary" id="btnCheckSpeak">Verificar</button>
            </div>
            <div id="fb"></div>
          </div>
        `);
        $("btnCheckSpeak").onclick=()=>{
          const got = $("txtSpeak").value;
          const ok = norm(got) === norm(s.expected);
          const fb2 = $("fb"); fb2.innerHTML="";
          if(ok){
            run.hits++; award(18); beep("good"); flash("good");
            fb2.appendChild(showFeedback("good","Boa!","Mesmo sem microfone, voc√™ fixou a estrutura.", "Bora pro grammar fix."));
            setTimeout(()=>nextStep(), 450);
          }else{
            run.miss++; award(4); beep("bad"); flash("bad");
            const d = diagnose(s.expected, got);
            addCommonError(d.key);
            fb2.appendChild(showFeedback("bad","Ops!","Troco por outro exerc√≠cio speaking (mesma meta).", d.msg));
            setTimeout(()=>replaceCurrentWithSameType(), 700);
          }
        };
      };
      return;
    }

    if(s.type==="GRAMMAR"){
      const tokens = s.tokens.map(t=>`<span class="token ${t.cls}"><b>${t.k}</b> ${t.v} ‚Äî ${t.pt}</span>`).join("");
      const opts = s.options.map((o,idx)=>`<button class="opt" data-idx="${idx}">${o.t}</button>`).join("");
      stageHTML(`
        <div class="h2">${s.title}</div>
        <div class="muted" style="margin-top:6px">${s.rulePT}</div>
        <div class="divider"></div>
        <div>${tokens}</div>
        <div class="panel">
          <div class="h3">${s.challengePT}</div>
          <div class="opts">${opts}</div>
          <div id="fb"></div>
        </div>
      `);
      const buttons = Array.from($("stage").querySelectorAll(".opt"));
      buttons.forEach(btn=>{
        btn.onclick=()=>{
          const idx = Number(btn.getAttribute("data-idx"));
          const ok = s.options[idx].ok;
          buttons.forEach(b=>b.disabled=true);
          if(ok){
            btn.classList.add("correct");
            run.hits++; award(16); beep("good"); flash("good");
            $("fb").appendChild(showFeedback("good","Boa!","Voc√™ escolheu a forma mais natural.", s.explainPT));
            setTimeout(()=>nextStep(), 450);
          }else{
            btn.classList.add("wrong");
            run.miss++; award(4); beep("bad"); flash("bad");
            addCommonError("ARTICLES_A_AN");
            $("fb").appendChild(showFeedback("bad","Quase!","Vou trocar por outro grammar fix (mesma regra) sem repetir.", s.explainPT));
            setTimeout(()=>replaceCurrentWithSameType(), 650);
          }
        };
      });
      return;
    }

    if(s.type==="BOSS"){
      stageHTML(`
        <div class="h2">${s.title}</div>
        <div class="muted" style="margin-top:6px">${s.promptPT}</div>
        <div class="divider"></div>
        <div class="muted"><b>Objetivo:</b> responder com 2 frases completas.</div>
        <div class="panel">
          <input id="txtBoss" type="text" placeholder="Digite sua resposta completa..." />
          <div class="mini" style="margin-top:6px">${s.hintPT}</div>
          <div class="row" style="margin-top:10px">
            <button class="primary" id="btnBoss">Finalizar</button>
          </div>
          <div id="fb"></div>
        </div>
      `);
      $("btnBoss").onclick=()=>{
        const got = $("txtBoss").value;
        const ok = similarity(norm(got), norm(s.expected)) >= 0.86;
        const fb = $("fb"); fb.innerHTML="";
        if(ok){
          run.hits++; award(40); beep("good"); flash("good");
          if(!state.saved.includes(s.expected)){
            state.saved.unshift(s.expected);
            state.saved = state.saved.slice(0, 25);
          }
          fb.appendChild(showFeedback("good","Voc√™ passou no Final Boss!","Agora voc√™ realmente consolidou a estrutura.", "A aula terminou ‚Äî bora pro pr√≥ximo epis√≥dio depois."));
          setTimeout(()=>nextStep(), 700);
        }else{
          run.miss++; award(6); beep("bad"); flash("bad");
          const d = diagnose(s.expected, got);
          addCommonError(d.key);
          fb.appendChild(showFeedback("bad","Ainda n√£o.","Sem problema. Vou trocar o cen√°rio (mesma meta) e voc√™ tenta novamente.", d.msg));
          setTimeout(()=>replaceCurrentWithSameType(), 900);
        }
      };
      return;
    }
  }

  // Similarity (simple) for speaking/dictation tolerance
  function similarity(a,b){
    if(!a && !b) return 1;
    if(!a || !b) return 0;
    const A=a.split(" "), B=b.split(" ");
    const setA=new Set(A);
    let hit=0;
    for(const w of B) if(setA.has(w)) hit++;
    return hit / Math.max(B.length, 1);
  }

  function startLesson(){
    stopSpeak();
    run.active=true;
    run.i=0;
    run.xpRun=0;
    run.hits=0;
    run.miss=0;
    lessonSteps = buildLessonSteps();
    show("lesson");
    nextStep();
  }

  function endLesson(){
    run.active=false;
    stopSpeak();
    show("home");
    renderAll();
  }

  // global hear button
  $("btnHear").onclick=()=>{
    const s=run.current;
    if(!s) return;
    const t = s.audioText || s.tts || s.expected || "";
    if(t) speak(t);
  };
  $("btnSkip").onclick=()=>{
    // swap current with same type (no penalty)
    if(!run.active || !run.current) return;
    if(run.current.type==="STORY"){ nextStep(); return; }
    replaceCurrentWithSameType();
  };
  $("btnExit").onclick=()=>endLesson();
  $("btnEnd").onclick=()=>endLesson();

  // settings
  $("btnTestVoice").onclick=()=>{ensureAudio(); speak("Hello! This is your English lesson.");};
  $("btnStopVoice").onclick=()=>stopSpeak();
  $("btnResetSession").onclick=()=>{
    if(!confirm("Resetar banco da sess√£o (sem repeti√ß√£o)?")) return;
    state.usedIds=[];
    store.set(KEY,state);
    alert("Banco da sess√£o resetado.");
  };
  $("btnResetAll").onclick=()=>{
    if(!confirm("Reset TOTAL? Zera XP e tudo.")) return;
    state=JSON.parse(JSON.stringify(DEFAULT));
    state.lastDay=todayKey();
    store.set(KEY,state);
    renderAll();
    alert("Reset feito.");
  };

  // coach
  function renderCoach(){
    const ul=$("saved");
    ul.innerHTML="";
    (state.saved||[]).slice(0,18).forEach(x=>{
      const li=document.createElement("li");
      li.textContent=x;
      ul.appendChild(li);
    });

    const entries = Object.entries(state.commonErrors||{}).sort((a,b)=>b[1]-a[1]).slice(0,8);
    const box=$("commonErrors");
    if(!entries.length){
      box.textContent="Ainda sem erros registrados. Fa√ßa a aula e volte aqui.";
      return;
    }
    box.innerHTML = entries.map(([k,v])=>`‚Ä¢ <b>${k}</b> ‚Äî ${v}x`).join("<br/>");
  }

  // render home
  function renderAll(){
    $("xp").textContent=state.xp;
    $("streak").textContent=state.streak;
    $("level").textContent="A1";
    $("stepN").textContent="0";
    $("bar").style.width="0%";
    $("stepLabel").textContent="‚Äî";
    store.set(KEY,state);
  }

  // nav buttons
  $("btnStart").onclick=startLesson;
  $("btnJumpLesson").onclick=()=>{show("lesson");};
  $("btnBackCoach").onclick=()=>{show("home"); renderAll();};
  $("btnBackSettings").onclick=()=>{show("home"); renderAll();};

  // top nav direct
  $("tabCoach").onclick=()=>{show("coach"); renderCoach();};
  $("tabSettings").onclick=()=>{show("settings");};
  $("tabLesson").onclick=()=>{show("lesson");};

  renderAll();
})();
</script>
</body>
</html>