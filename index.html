<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ingl√™s Pro Premium ‚Äì Claudio</title>
<style>
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#e0e7ff;color:#0f172a}
  .container{max-width:640px;margin:0 auto;padding:14px;min-height:100vh}
  .screen{display:none}
  .screen.active{display:block}

  .header{
    background:linear-gradient(135deg,#4f46e5,#2563eb);
    color:#fff;border-radius:18px;padding:14px;text-align:center;position:relative;
    box-shadow:0 16px 32px rgba(0,0,0,.10); margin-bottom:10px;
  }
  .backbtn{
    position:absolute; left:10px; top:10px;
    border:none; background:rgba(255,255,255,.18);
    color:#fff; border-radius:12px; padding:8px 10px; cursor:pointer; font-weight:900;
  }
  .card{
    background:#fff;border-radius:18px;padding:14px;margin-bottom:10px;
    box-shadow:0 16px 32px rgba(0,0,0,.10)
  }
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .pill{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;
    font-weight:900;font-size:12px;color:#3730a3
  }
  .muted{opacity:.9}
  .small{font-size:13px;color:#475569}
  .tiny{font-size:12px;color:#64748b}

  .btn{
    border:none;border-radius:14px;padding:12px 14px;font-weight:950;cursor:pointer;
    transition:transform .08s ease, filter .08s ease;
  }
  .btn:active{transform:scale(.99)}
  .btn-primary{background:#4f46e5;color:#fff}
  .btn-success{background:#10b981;color:#fff}
  .btn-ghost{background:#f1f5f9;color:#0f172a}
  .btn-danger{background:#ef4444;color:#fff}
  .btn-full{width:100%}
  .btn-small{padding:8px 10px;border-radius:12px;font-weight:950}

  .choice{
    border:2px solid #d1d5db;border-radius:14px;padding:12px;margin-top:10px;
    cursor:pointer; user-select:none;
  }
  .choice:hover{border-color:#4f46e5}
  .choice.selected{border-color:#4f46e5; box-shadow:0 0 0 2px rgba(79,70,229,.10) inset;}

  input[type="text"]{
    width:100%;padding:12px;border:2px solid #d1d5db;border-radius:14px;font-size:16px;margin-top:10px
  }
  .feedback{padding:12px;border-radius:14px;margin-top:12px}
  .ok{background:#ecfdf5;border:2px solid #10b981}
  .bad{background:#fff7ed;border:2px solid #fb923c}
  .tip{background:#eef2ff;border:2px solid #c7d2fe}

  .progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .progress>div{height:10px;background:#4f46e5;width:0%}

  /* Flash + Overlay (feedback estilo game) */
  .flash{animation:flash .22s ease-in-out}
  .flash-ok{box-shadow:0 0 0 3px rgba(16,185,129,.35) inset;}
  .flash-bad{box-shadow:0 0 0 3px rgba(239,68,68,.35) inset;}
  @keyframes flash{
    0%{transform:scale(1);filter:saturate(1)}
    50%{transform:scale(1.01);filter:saturate(1.2)}
    100%{transform:scale(1);filter:saturate(1)}
  }
  .overlay{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .13s ease}
  .overlay.ok{background:rgba(16,185,129,.16)}
  .overlay.bad{background:rgba(239,68,68,.20)}
  .overlay.show{opacity:1}

  .listItem{
    border:2px solid #e5e7eb;border-radius:16px;padding:12px;margin-top:10px;cursor:pointer
  }
  .listItem:hover{border-color:#4f46e5}
  .listItem.done{background:#f0fdf4;border-color:#10b981}
  .title{font-weight:950}
  .sub{font-size:12px;color:#64748b;margin-top:4px}

  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
       font-size:12px;background:#0f172a;color:#fff;border-radius:8px;padding:2px 6px}

  textarea{
    width:100%;min-height:120px;border:2px solid #d1d5db;border-radius:14px;padding:10px;font-size:13px
  }
</style>
</head>

<body>
<div class="container">

  <!-- HOME -->
  <div id="home" class="screen active">
    <div class="header">
      <h2 style="margin:0">üéÆ Ingl√™s Pro Premium</h2>
      <p class="muted" style="margin:6px 0 0 0">Game + Treinador Inteligente + Banco grande</p>
    </div>

    <div class="card">
      <div class="row" style="justify-content:center;gap:8px">
        <span class="pill">‚ö° XP: <span id="xpTxt">0</span></span>
        <span class="pill">üî• Streak: <span id="streakTxt">0</span></span>
        <span class="pill">üèÖ Badges: <span id="badgeTxt">0</span></span>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <span class="pill">N√≠vel atual: <b id="userLevelTxt">B√°sico</b></span>
        <span class="pill">Dificuldade: <b id="diffTxt">1</b>/5</span>
      </div>

      <div style="height:10px"></div>
      <div class="grid2">
        <button id="btnChooseLevel" class="btn btn-primary btn-full">üìö Aulas por n√≠vel</button>
        <button id="btnChallenge" class="btn btn-ghost btn-full">üé≤ Desafio (misturado)</button>
      </div>

      <div style="height:10px"></div>
      <div class="grid2">
        <button id="btnPlacement" class="btn btn-ghost btn-full">üß™ Teste de n√≠vel (premium)</button>
        <button id="btnCoach" class="btn btn-success btn-full">ü§ñ Treinador Inteligente</button>
      </div>

      <div style="height:10px"></div>
      <div class="row">
        <label class="pill" style="cursor:pointer">
          <input id="voiceToggle" type="checkbox" checked style="transform:scale(1.2);margin-right:8px"> üîä Voz
        </label>
        <label class="pill" style="cursor:pointer">
          <input id="sfxToggle" type="checkbox" checked style="transform:scale(1.2);margin-right:8px"> üîî Sons
        </label>
        <label class="pill" style="cursor:pointer">
          <input id="vibToggle" type="checkbox" checked style="transform:scale(1.2);margin-right:8px"> üì≥ Vibra√ß√£o
        </label>
      </div>

      <p class="small" style="margin:10px 0 0 0">
        Dica: no celular, use GitHub Pages e ‚ÄúAdicionar √† tela inicial‚Äù para virar app.
      </p>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <div class="title">Progresso</div>
          <div class="sub" id="progressSummary"></div>
        </div>
        <button id="btnReset" class="btn btn-danger btn-small">Zerar</button>
      </div>

      <div style="height:10px"></div>
      <div class="grid2">
        <button id="btnExport" class="btn btn-ghost btn-full">‚¨áÔ∏è Exportar</button>
        <button id="btnImport" class="btn btn-ghost btn-full">‚¨ÜÔ∏è Importar</button>
      </div>
    </div>

    <div class="card">
      <div class="title">Badges (gamifica√ß√£o)</div>
      <div class="small" id="badgeList" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- LEVELS -->
  <div id="levels" class="screen">
    <div class="header">
      <button class="backbtn" id="backHome1">‚Üê</button>
      <h2 style="margin:0">N√≠veis</h2>
      <p class="muted" style="margin:6px 0 0 0">Escolha um n√≠vel para ver as aulas</p>
    </div>
    <div class="card" id="levelsList"></div>
  </div>

  <!-- LESSON LIST -->
  <div id="lessonList" class="screen">
    <div class="header">
      <button class="backbtn" id="backLevels">‚Üê</button>
      <h2 style="margin:0" id="lessonListTitle">Aulas</h2>
      <p class="muted" style="margin:6px 0 0 0" id="lessonListSub"></p>
    </div>
    <div class="card" id="lessonsList"></div>
  </div>

  <!-- PLAYER -->
  <div id="player" class="screen">
    <div class="header">
      <button class="backbtn" id="backToList">‚Üê</button>
      <h2 style="margin:0" id="playerTitle">Aula</h2>
      <div style="height:10px"></div>
      <div class="progress"><div id="bar"></div></div>
      <p class="tiny" id="stepInfo" style="margin:8px 0 0 0"></p>
    </div>

    <div class="card" id="content"></div>

    <div class="card">
      <div class="row">
        <button id="listenBtn" class="btn btn-ghost btn-small">üîä Ouvir</button>
        <button id="hintBtn" class="btn btn-ghost btn-small">üí° Dica</button>
        <button id="skipBtn" class="btn btn-ghost btn-small">‚è≠Ô∏è Pular</button>
      </div>

      <div style="height:10px"></div>
      <button id="checkBtn" class="btn btn-primary btn-full">Verificar</button>
      <button id="nextBtn" class="btn btn-success btn-full" style="display:none">Pr√≥ximo ‚Üí</button>
    </div>
  </div>

  <!-- END -->
  <div id="end" class="screen">
    <div class="header">
      <h2 style="margin:0">üéâ Final</h2>
      <p class="muted" style="margin:6px 0 0 0" id="endSub"></p>
    </div>
    <div class="card" id="endCard"></div>
    <div class="card">
      <button id="endBackBtn" class="btn btn-primary btn-full">üìö Voltar</button>
      <div style="height:10px"></div>
      <button id="endHomeBtn" class="btn btn-ghost btn-full">üè† Home</button>
    </div>
  </div>

  <!-- IMPORT/EXPORT MODAL (simple) -->
  <div id="transfer" class="screen">
    <div class="header">
      <button class="backbtn" id="backHome2">‚Üê</button>
      <h2 style="margin:0">Transfer√™ncia</h2>
      <p class="muted" style="margin:6px 0 0 0">Exportar/Importar progresso</p>
    </div>
    <div class="card">
      <div class="title" style="margin-bottom:8px">Texto de dados</div>
      <textarea id="transferBox" placeholder="Aqui aparece o export. Para importar, cole e clique em Importar."></textarea>
      <div style="height:10px"></div>
      <div class="grid2">
        <button id="doExport" class="btn btn-ghost btn-full">Gerar export</button>
        <button id="doImport" class="btn btn-primary btn-full">Importar</button>
      </div>
      <p class="tiny" style="margin-top:10px">
        Dica: copie e envie pra sua esposa, assim voc√™s testam com o mesmo progresso.
      </p>
    </div>
  </div>

</div>

<div id="overlay" class="overlay"></div>

<script>
'use strict';

/* ===================== HELPERS ===================== */
function byId(id){ return document.getElementById(id); }
function show(id){
  var screens = document.querySelectorAll('.screen');
  for(var i=0;i<screens.length;i++) screens[i].classList.remove('active');
  byId(id).classList.add('active');
}
function normalize(s){ return (s||'').toString().trim().toLowerCase(); }
function cloneArray(a){ var o=[]; for(var i=0;i<a.length;i++) o.push(a[i]); return o; }
function shuffle(a){
  for(var i=a.length-1;i>0;i--){
    var j = Math.floor(Math.random()*(i+1));
    var t=a[i]; a[i]=a[j]; a[j]=t;
  }
  return a;
}
function todayKey(){
  var d=new Date();
  return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
}

/* ===================== STORAGE ===================== */
var STORE='inglesPro_premium_v1';
function loadState(){
  try{
    var raw=localStorage.getItem(STORE);
    if(!raw) return null;
    var obj=JSON.parse(raw);
    if(!obj||typeof obj!=='object') return null;
    return obj;
  }catch(e){ return null; }
}
function saveState(){
  try{ localStorage.setItem(STORE, JSON.stringify(state)); }catch(e){}
}
var state = loadState() || {
  xp:0,
  streak:0,
  lastDay:null,
  badges:{},
  progress:{}, // lessonId -> {done,date}
  userLevelId:'basic',
  diff:1, // 1..5
  coach:{topic:null, skill:null, wrongStreak:0}
};

/* ===================== AUDIO / SFX / VIB ===================== */
var voiceOn=true, sfxOn=true, vibOn=true;
var _audioCtx=null;
function ensureAudio(){
  if(!_audioCtx){
    var AC = window.AudioContext || window.webkitAudioContext;
    if(AC) _audioCtx=new AC();
  }
  if(_audioCtx && _audioCtx.state==='suspended'){
    _audioCtx.resume().catch(function(){});
  }
}
function speak(text){
  if(!voiceOn) return;
  try{
    if(!('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    var u=new SpeechSynthesisUtterance(text);
    u.lang='en-US';
    u.rate=0.88;
    window.speechSynthesis.speak(u);
  }catch(e){}
}
function beep(freq,dur,type,gain){
  if(!sfxOn) return;
  ensureAudio();
  if(!_audioCtx) return;
  var osc=_audioCtx.createOscillator();
  var g=_audioCtx.createGain();
  osc.type=type||'sine';
  osc.frequency.value=freq;
  var now=_audioCtx.currentTime;
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(gain||0.16, now+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now+(dur/1000));
  osc.connect(g); g.connect(_audioCtx.destination);
  osc.start(now); osc.stop(now+(dur/1000)+0.02);
}
function sfxCorrect(){
  beep(880,80,'sine',0.16);
  setTimeout(function(){beep(1320,110,'sine',0.14);},70);
}
function sfxWrong(){
  beep(180,140,'square',0.22);
  setTimeout(function(){beep(120,160,'sawtooth',0.18);},120);
}
function vibrate(ms){
  if(!vibOn) return;
  try{ if(navigator.vibrate) navigator.vibrate(ms||80); }catch(e){}
}
function flash(kind, contentId){
  var el=byId(contentId||'content');
  var ov=byId('overlay');
  if(!el||!ov) return;
  el.classList.remove('flash','flash-ok','flash-bad'); void el.offsetWidth;
  el.classList.add('flash', kind==='ok'?'flash-ok':'flash-bad');
  ov.className='overlay '+(kind==='ok'?'ok':'bad')+' show';
  setTimeout(function(){ov.classList.remove('show');},150);
}

/* ===================== GAMIFICATION ===================== */
var BADGES = [
  {id:'first_win', name:'Primeira vit√≥ria', rule:function(){return state.xp>=10}},
  {id:'streak3', name:'Streak 3 dias', rule:function(){return state.streak>=3}},
  {id:'streak7', name:'Streak 7 dias', rule:function(){return state.streak>=7}},
  {id:'xp500', name:'500 XP', rule:function(){return state.xp>=500}},
  {id:'complete_basic', name:'B√°sico completo', rule:function(){
    return hasCompletedAll('basic');
  }},
  {id:'no_skip_10', name:'Sem pular (10 acertos)', rule:function(){return (state.badges._noskip10===true)}}
];

function levelNameById(id){
  if(id==='basic') return 'B√°sico';
  if(id==='pre') return 'Pr√©-Intermedi√°rio';
  if(id==='intermediate') return 'Intermedi√°rio';
  if(id==='preadv') return 'Pr√©-Avan√ßado';
  if(id==='adv') return 'Avan√ßado';
  return 'B√°sico';
}

function updateStreak(){
  var t=todayKey();
  if(state.lastDay===t) return;
  if(!state.lastDay){
    state.streak=1; state.lastDay=t; return;
  }
  // checa se ontem
  var d=new Date();
  var y=new Date(d.getFullYear(), d.getMonth(), d.getDate()-1);
  var ykey=y.getFullYear()+'-'+String(y.getMonth()+1).padStart(2,'0')+'-'+String(y.getDate()).padStart(2,'0');
  if(state.lastDay===ykey) state.streak+=1;
  else state.streak=1;
  state.lastDay=t;
}

function addXP(points){
  updateStreak();
  state.xp += points;
  if(state.xp<0) state.xp=0;
  // ajuste de dificuldade autom√°tica (bem simples)
  // sobe se xp aumenta e errando pouco
  if(state.xp>=200 && state.diff<3) state.diff=3;
  if(state.xp>=400 && state.diff<4) state.diff=4;
  if(state.xp>=700 && state.diff<5) state.diff=5;
  unlockBadges();
  saveState();
}

function unlockBadges(){
  for(var i=0;i<BADGES.length;i++){
    var b=BADGES[i];
    if(!state.badges[b.id] && b.rule()){
      state.badges[b.id]= {name:b.name, date:(new Date()).toLocaleDateString('pt-BR')};
      // mini bonus xp
      state.xp += 15;
    }
  }
}

function badgesCount(){
  var c=0;
  for(var k in state.badges){
    if(k.indexOf('_')===0) continue;
    if(state.badges.hasOwnProperty(k)) c++;
  }
  return c;
}

/* ===================== BANK (HUGE & SCALABLE) ===================== */
/*
  Premium: em vez de escrever 1000 quest√µes na m√£o,
  a gente usa:
  - bancos de frases por tema
  - geradores por skill (choice/input/fill/listening)
  Isso permite multiplicar o banco ‚Äúinfinito‚Äù sem quebrar.
*/
function Q(type, q, a, options, say, hint, explain, meta){
  return {
    type:type,
    q:q, a:a,
    options:options||null,
    say:say||null,
    hint:hint||'',
    explain:explain||'',
    meta: meta || {level:'basic', topic:'general', skill:'grammar', diff:1}
  };
}

var TOPICS = ['work','home','travel','cinema','school','police','politics'];

var PHRASES = {
  // BASIC
  basic:{
    work:[
      {en:'I work in training.', pt:'Eu trabalho no treinamento.'},
      {en:'I train employees.', pt:'Eu treino funcion√°rios.'},
      {en:'I have a meeting today.', pt:'Eu tenho uma reuni√£o hoje.'},
      {en:'I need to practice.', pt:'Eu preciso praticar.'},
      {en:'I help my team.', pt:'Eu ajudo meu time.'}
    ],
    home:[
      {en:'I am at home.', pt:'Eu estou em casa.'},
      {en:'I have two kids.', pt:'Eu tenho dois filhos.'},
      {en:'I cook dinner.', pt:'Eu fa√ßo o jantar.'},
      {en:'I go to bed early.', pt:'Eu durmo cedo.'},
      {en:'I wake up at 4.', pt:'Eu acordo √†s 4.'}
    ],
    travel:[
      {en:'I go to the airport.', pt:'Eu vou ao aeroporto.'},
      {en:'I need a ticket.', pt:'Eu preciso de um bilhete.'},
      {en:'Where is the hotel?', pt:'Onde fica o hotel?'},
      {en:'I want water, please.', pt:'Eu quero √°gua, por favor.'},
      {en:'I am from Brazil.', pt:'Eu sou do Brasil.'}
    ],
    cinema:[
      {en:'I like this movie.', pt:'Eu gosto desse filme.'},
      {en:'The movie is good.', pt:'O filme √© bom.'},
      {en:'I want popcorn.', pt:'Eu quero pipoca.'},
      {en:'What time is it?', pt:'Que horas s√£o?'},
      {en:'Let‚Äôs watch it.', pt:'Vamos assistir.'}
    ],
    school:[
      {en:'I study English.', pt:'Eu estudo ingl√™s.'},
      {en:'This is my notebook.', pt:'Esse √© meu caderno.'},
      {en:'I have homework.', pt:'Eu tenho li√ß√£o.'},
      {en:'I need help.', pt:'Eu preciso de ajuda.'},
      {en:'What is the answer?', pt:'Qual √© a resposta?'}
    ],
    police:[
      {en:'I need help, officer.', pt:'Eu preciso de ajuda, policial.'},
      {en:'My phone was stolen.', pt:'Meu celular foi roubado.'},
      {en:'I lost my ID.', pt:'Eu perdi meu documento.'},
      {en:'Is it safe here?', pt:'√â seguro aqui?'},
      {en:'Please call the police.', pt:'Por favor chame a pol√≠cia.'}
    ],
    politics:[
      {en:'I want to vote.', pt:'Eu quero votar.'},
      {en:'This is my opinion.', pt:'Essa √© minha opini√£o.'},
      {en:'I respect different views.', pt:'Eu respeito opini√µes diferentes.'},
      {en:'We need a plan.', pt:'Precisamos de um plano.'},
      {en:'Let‚Äôs focus on solutions.', pt:'Vamos focar em solu√ß√µes.'}
    ]
  },

  // PRE / INTER / PRE-ADV / ADV (exemplos; gerador multiplica)
  pre:{
    work:[
      {en:'I am working now.', pt:'Eu estou trabalhando agora.'},
      {en:'I worked yesterday.', pt:'Eu trabalhei ontem.'},
      {en:'I will study tomorrow.', pt:'Eu vou estudar amanh√£.'},
      {en:'I‚Äôm going to call you later.', pt:'Vou te ligar mais tarde.'}
    ],
    travel:[
      {en:'I have never been here.', pt:'Eu nunca estive aqui.'},
      {en:'Did you book the hotel?', pt:'Voc√™ reservou o hotel?'}
    ],
    cinema:[
      {en:'We watched a movie last night.', pt:'A gente assistiu um filme ontem √† noite.'}
    ]
  },
  intermediate:{
    work:[
      {en:'You should practice daily.', pt:'Voc√™ deveria praticar diariamente.'},
      {en:'If you study, you will improve.', pt:'Se voc√™ estudar, voc√™ vai melhorar.'},
      {en:'This lesson is easier than the last one.', pt:'Essa li√ß√£o √© mais f√°cil que a anterior.'}
    ],
    politics:[
      {en:'However, there are risks.', pt:'Por√©m, h√° riscos.'},
      {en:'Therefore, we need a plan.', pt:'Portanto, precisamos de um plano.'}
    ]
  },
  preadv:{
    work:[
      {en:'I have worked here for 5 years.', pt:'Eu trabalho aqui h√° 5 anos.'},
      {en:'The report was sent.', pt:'O relat√≥rio foi enviado.'}
    ]
  },
  adv:{
    work:[
      {en:'I‚Äôm used to working early.', pt:'Eu estou acostumado a trabalhar cedo.'},
      {en:'Rarely do I see that.', pt:'Raramente eu vejo isso.'},
      {en:'I would appreciate it if you could clarify.', pt:'Eu apreciaria se voc√™ pudesse esclarecer.'}
    ]
  }
};

/* ---------- Generators ---------- */
function makeChoicesCorrect(en){
  // cria 2 ‚Äúdistratores‚Äù comuns
  // simples por√©m eficaz pro p√∫blico b√°sico
  var w = en.split(' ');
  var wrong1 = en.replace('I am','I').replace('I\'m','I').replace(' do ',' ').trim();
  var wrong2 = en.replace('I ','I does ').replace('I does','I do').trim();
  if(wrong1===en) wrong1 = en.replace('in','on');
  if(wrong2===en) wrong2 = en.replace(' at ',' in ');
  var opts = [en, wrong1, wrong2];
  // remove duplicatas
  var u=[], seen={};
  for(var i=0;i<opts.length;i++){
    var k=opts[i];
    if(!seen[k]){ seen[k]=true; u.push(k); }
  }
  while(u.length<3) u.push(en + ' ...'); // fallback
  return shuffle(u);
}

function genQuestionsForLevel(levelId, topic, skill, diff){
  // diff: 1..5
  var bank = (PHRASES[levelId] && PHRASES[levelId][topic]) ? PHRASES[levelId][topic] : [];
  if(bank.length===0){
    // fallback
    bank = [{en:'I study English.',pt:'Eu estudo ingl√™s.'}];
  }

  var out = [];
  var pick = bank[Math.floor(Math.random()*bank.length)];
  var en = pick.en;
  var pt = pick.pt;

  // skills: vocab, grammar, fill, listening
  if(skill==='vocab'){
    out.push(Q(
      'choice',
      'Qual √© a melhor tradu√ß√£o para: "'+en+'" ?',
      pt,
      shuffle([pt, 'Tradu√ß√£o errada (1)', 'Tradu√ß√£o errada (2)']),
      en,
      'Dica: pense no sentido geral da frase, n√£o palavra por palavra.',
      'Vocabul√°rio: associe a frase a uma imagem mental.',
      {level:levelId, topic:topic, skill:skill, diff:diff}
    ));
  }
  else if(skill==='grammar'){
    out.push(Q(
      'choice',
      'Escolha a frase correta:',
      en,
      makeChoicesCorrect(en),
      en,
      'Dica: observe o tempo verbal e a estrutura (I + verbo base / am-is-are + ing).',
      'Gram√°tica: forma correta e natural em ingl√™s.',
      {level:levelId, topic:topic, skill:skill, diff:diff}
    ));
  }
  else if(skill==='fill'){
    // cria um blank simples
    var parts = en.split(' ');
    var idx = Math.min(2, Math.max(1, Math.floor(parts.length/2)));
    var answer = parts[idx];
    parts[idx] = '___';
    var qtxt = parts.join(' ');
    out.push(Q(
      'input',
      'Complete: '+qtxt,
      answer,
      null,
      en,
      'Dica: complete com UMA palavra. Relembre a frase modelo.',
      'Fill the blank: complete com a palavra correta.',
      {level:levelId, topic:topic, skill:skill, diff:diff}
    ));
  }
  else if(skill==='listening'){
    // listening: usu√°rio ouve e escolhe o que ouviu
    out.push(Q(
      'choice',
      'Listening: clique em üîä e escolha o que voc√™ ouviu.',
      en,
      makeChoicesCorrect(en),
      en,
      'Dica: foque nas palavras-chave e no ritmo.',
      'Listening: treine seu ouvido em frases reais.',
      {level:levelId, topic:topic, skill:skill, diff:diff}
    ));
  }

  return out;
}

function randomSkillByDiff(diff){
  // Diff aumenta a chance de listening e fill
  if(diff<=1) return ['grammar','vocab'][Math.floor(Math.random()*2)];
  if(diff===2) return ['grammar','vocab','fill'][Math.floor(Math.random()*3)];
  if(diff===3) return ['grammar','vocab','fill','listening'][Math.floor(Math.random()*4)];
  if(diff===4) return ['fill','listening','grammar','vocab'][Math.floor(Math.random()*4)];
  return ['listening','fill','grammar','vocab'][Math.floor(Math.random()*4)];
}

/* ===================== LEVELS / LESSONS (Premium) ===================== */
function makeLesson(id, name, desc, levelId, topics){
  return {id:id, name:name, desc:desc, levelId:levelId, topics:topics};
}
function levelObj(id,name,lessons){ return {id:id,name:name,lessons:lessons}; }

var LEVELS = [
  levelObj('basic','B√°sico',[
    makeLesson('basic-1','B√°sico 1 ‚Äì Rotina','Frases do dia a dia + estrutura I + verbo', 'basic', ['work','home','school']),
    makeLesson('basic-2','B√°sico 2 ‚Äì Lugar/tempo','in/on/at + rotina pr√°tica', 'basic', ['work','travel','home']),
    makeLesson('basic-3','B√°sico 3 ‚Äì Perguntas','Do you‚Ä¶? / Where‚Ä¶?', 'basic', ['work','school','travel'])
  ]),
  levelObj('pre','Pr√©-Intermedi√°rio',[
    makeLesson('pre-1','Pr√© 1 ‚Äì Now vs routine','Present continuous e pr√°tica', 'pre', ['work','home','travel']),
    makeLesson('pre-2','Pr√© 2 ‚Äì Past','yesterday / didn‚Äôt / did', 'pre', ['work','cinema','travel']),
    makeLesson('pre-3','Pr√© 3 ‚Äì Future','will / going to', 'pre', ['work','travel','politics'])
  ]),
  levelObj('intermediate','Intermedi√°rio',[
    makeLesson('int-1','Inter 1 ‚Äì Comparatives','better, easier, the best', 'intermediate', ['work','cinema','school']),
    makeLesson('int-2','Inter 2 ‚Äì Modals','should/must/could', 'intermediate', ['work','police','travel']),
    makeLesson('int-3','Inter 3 ‚Äì Linkers & If','however/therefore + if', 'intermediate', ['work','politics','school'])
  ]),
  levelObj('preadv','Pr√©-Avan√ßado',[
    makeLesson('pa-1','Pr√©-Av 1 ‚Äì Present perfect','have/has + pp', 'preadv', ['work','travel','cinema']),
    makeLesson('pa-2','Pr√©-Av 2 ‚Äì Passive','was sent / is checked', 'preadv', ['work','police','politics']),
    makeLesson('pa-3','Pr√©-Av 3 ‚Äì Reported','he said‚Ä¶', 'preadv', ['work','school','politics'])
  ]),
  levelObj('adv','Avan√ßado',[
    makeLesson('adv-1','Av 1 ‚Äì Nuance','used to / inversion', 'adv', ['work','politics','travel']),
    makeLesson('adv-2','Av 2 ‚Äì Collocations','make a decision', 'adv', ['work','school','politics']),
    makeLesson('adv-3','Av 3 ‚Äì Writing tone','however/therefore', 'adv', ['work','politics','police'])
  ])
];

function findLevel(id){
  for(var i=0;i<LEVELS.length;i++) if(LEVELS[i].id===id) return LEVELS[i];
  return LEVELS[0];
}

/* ===================== ENGINE (Adaptive Coach) ===================== */
var mode = 'lesson'; // lesson | challenge | coach | placement
var currentLevel = null;
var currentLesson = null;

var qQueue = [];
var reinforceQueue = [];
var qIndex = 0;
var selected = null;
var correctStreak = 0;
var noSkipCounter = 0;

function pushReinforce(levelId, topic, diff){
  // 3 refor√ßos do MESMO tema, skill variando
  reinforceQueue = [];
  for(var i=0;i<3;i++){
    var skill = randomSkillByDiff(Math.max(1, diff-1));
    var qs = genQuestionsForLevel(levelId, topic, skill, Math.max(1, diff-1));
    reinforceQueue = reinforceQueue.concat(qs);
  }
  reinforceQueue = shuffle(reinforceQueue);
}

function buildLessonQueue(lesson){
  // premium: cria ~12 quest√µes por aula, misturando temas e skills de acordo com diff
  qQueue = [];
  reinforceQueue = [];
  qIndex = 0;
  selected = null;
  correctStreak = 0;
  noSkipCounter = 0;

  var diff = state.diff;
  var levelId = lesson.levelId;
  var topics = lesson.topics;

  // Gera 12 quest√µes (com ‚Äúvaria√ß√£o‚Äù)
  for(var i=0;i<12;i++){
    var topic = topics[Math.floor(Math.random()*topics.length)];
    var skill = randomSkillByDiff(diff);
    var qs = genQuestionsForLevel(levelId, topic, skill, diff);
    qQueue = qQueue.concat(qs);
  }
  qQueue = shuffle(qQueue);
}

function buildChallengeQueue(levelId){
  qQueue = [];
  reinforceQueue = [];
  qIndex = 0; selected=null; correctStreak=0; noSkipCounter=0;

  var diff = state.diff;
  for(var i=0;i<14;i++){
    var topic = TOPICS[Math.floor(Math.random()*TOPICS.length)];
    var skill = randomSkillByDiff(diff);
    var qs = genQuestionsForLevel(levelId, topic, skill, diff);
    qQueue = qQueue.concat(qs);
  }
  qQueue = shuffle(qQueue);
}

function buildCoachQueue(){
  // coach escolhe tema e skill dinamicamente com base nos erros
  qQueue = [];
  reinforceQueue = [];
  qIndex = 0; selected=null; correctStreak=0; noSkipCounter=0;

  var levelId = state.userLevelId;
  var diff = state.diff;

  var topic = state.coach.topic || TOPICS[Math.floor(Math.random()*TOPICS.length)];
  var skill = state.coach.skill || randomSkillByDiff(diff);

  // 18 quest√µes "treinador"
  for(var i=0;i<18;i++){
    var qs = genQuestionsForLevel(levelId, topic, skill, diff);
    qQueue = qQueue.concat(qs);
    // varia um pouco
    if(i%4===3) skill = randomSkillByDiff(diff);
    if(i%6===5) topic = TOPICS[Math.floor(Math.random()*TOPICS.length)];
  }
  qQueue = shuffle(qQueue);
}

function currentQ(){
  if(reinforceQueue.length>0) return reinforceQueue[0];
  return qQueue[qIndex];
}

function updateBar(){
  var total = qQueue.length;
  var pos = qIndex;
  if(pos<0) pos=0;
  if(pos>total) pos=total;
  var pct = total ? Math.round((pos/total)*100) : 0;
  byId('bar').style.width = pct+'%';

  var q = currentQ();
  var tag = (q && q.meta) ? (q.meta.topic+' ‚Ä¢ '+q.meta.skill+' ‚Ä¢ diff '+q.meta.diff) : '';
  var msg = 'Quest√£o '+(qIndex+1)+' de '+total + (reinforceQueue.length>0 ? ('  ‚Ä¢ Refor√ßo: '+reinforceQueue.length) : '') + '  ‚Ä¢ '+tag;
  byId('stepInfo').textContent = msg;
}

function renderQuestion(){
  selected=null;
  byId('nextBtn').style.display='none';
  byId('checkBtn').style.display='block';

  var q=currentQ();
  if(!q){ finishSession(); return; }

  byId('content').innerHTML =
    '<div class="row">' +
      '<div class="title" style="font-size:18px">'+q.q+'</div>' +
      '<span class="pill">'+(reinforceQueue.length>0?'Refor√ßo':'Principal')+'</span>' +
    '</div>' +
    '<div class="tiny" style="margin-top:6px">' +
      '<b>Objetivo:</b> responda r√°pido, veja corre√ß√£o e avance.' +
    '</div>';

  var content=byId('content');

  if(q.type==='choice'){
    for(var i=0;i<q.options.length;i++){
      (function(opt){
        var div=document.createElement('div');
        div.className='choice';
        div.textContent=opt;
        div.addEventListener('click', function(){
          selected=opt;
          var all=content.querySelectorAll('.choice');
          for(var j=0;j<all.length;j++) all[j].classList.remove('selected');
          div.classList.add('selected');
        });
        content.appendChild(div);
      })(q.options[i]);
    }
  }else{
    content.innerHTML += '<input id="ans" type="text" placeholder="Digite aqui..." autocomplete="off"/>';
    setTimeout(function(){ var a=byId('ans'); if(a) a.focus(); }, 40);
  }

  updateBar();
}

function showHint(){
  var q=currentQ();
  var content=byId('content');
  if(content.querySelector('.feedback.tip')) return;

  var tip=document.createElement('div');
  tip.className='feedback tip';
  tip.innerHTML =
    '<b>Dica (o que se espera):</b><br>' +
    (q.hint || 'Pense na estrutura e escolha a forma mais natural.') +
    '<div class="tiny" style="margin-top:8px"><b>Micro-aula:</b> ' +
    (q.explain || 'Compare sua resposta com o modelo e foque no padr√£o.') +
    '</div>';
  content.appendChild(tip);
}

function listenNow(){
  var q=currentQ();
  ensureAudio();
  // listening: l√™ a frase (say), sen√£o l√™ pergunta curta
  if(q.say) speak(q.say);
  else speak(q.a || q.q);
}

function check(){
  var q=currentQ();
  var user='';
  if(q.type==='choice'){
    user = selected || '';
    if(!user){
      var warn=document.createElement('div');
      warn.className='feedback bad';
      warn.innerHTML='<b>Escolha uma op√ß√£o üëÜ</b><br>Depois clique em ‚ÄúVerificar‚Äù.';
      byId('content').appendChild(warn);
      return;
    }
  }else{
    var ans=byId('ans');
    user = ans ? ans.value : '';
    if(!user.trim()){
      var warn2=document.createElement('div');
      warn2.className='feedback bad';
      warn2.innerHTML='<b>Digite algo ‚úçÔ∏è</b><br>Mesmo simples, tenta.';
      byId('content').appendChild(warn2);
      return;
    }
  }

  var ok = normalize(user)===normalize(q.a);

  if(ok){
    flash('ok'); sfxCorrect(); vibrate(60);
    correctStreak++;
    noSkipCounter++;
    addXP(10 + Math.max(0, (q.meta.diff-1)*2));
  }else{
    flash('bad'); sfxWrong(); vibrate(140);
    correctStreak=0;
    noSkipCounter=0;
    addXP(-2); // penaliza leve

    // Treinador aprende onde voc√™ errou
    state.coach.topic = q.meta.topic;
    state.coach.skill = q.meta.skill;
    state.coach.wrongStreak = (state.coach.wrongStreak||0) + 1;

    // refor√ßo do mesmo t√≥pico e um pouco mais f√°cil
    pushReinforce(q.meta.level, q.meta.topic, Math.max(1, q.meta.diff-1));
    saveState();
  }

  // feedback
  var content=byId('content');
  var box=document.createElement('div');
  box.className='feedback '+(ok?'ok':'bad');
  box.innerHTML =
    (ok ? '<b>‚úÖ Acertou!</b>' : '<b>‚ùå Errou!</b>') +
    '<br><span class="small"><b>Voc√™:</b> '+String(user).replace(/</g,'&lt;')+'</span>' +
    '<br><span class="small"><b>Correto:</b> <span class="kbd">'+String(q.a).replace(/</g,'&lt;')+'</span></span>' +
    '<div class="tiny" style="margin-top:8px"><b>Por qu√™:</b> '+(q.explain || 'Padr√£o de frase e uso natural em ingl√™s.')+'</div>';

  content.appendChild(box);

  var btn=document.createElement('button');
  btn.className='btn btn-ghost btn-small';
  btn.style.marginTop='10px';
  btn.textContent='üîä Ouvir modelo';
  btn.addEventListener('click', function(){ ensureAudio(); speak(q.say || q.a); });
  content.appendChild(btn);

  byId('checkBtn').style.display='none';
  byId('nextBtn').style.display='block';
  updateHeaderStats();
}

function next(){
  // se est√° em refor√ßo, consome refor√ßo
  if(reinforceQueue.length>0){
    reinforceQueue.shift();
    renderQuestion();
    return;
  }

  qIndex++;
  if(qIndex>=qQueue.length){
    finishSession();
    return;
  }
  renderQuestion();
}

function skip(){
  // pular reduz xp e evita badge no-skip
  addXP(-1);
  state.badges._noskip10 = false;
  saveState();

  // se estava em refor√ßo, remove 1 e continua
  if(reinforceQueue.length>0){
    reinforceQueue.shift();
  }else{
    qIndex++;
  }
  renderQuestion();
}

/* ===================== SESSION END ===================== */
function markLessonDone(lesson){
  if(!lesson) return;
  state.progress[lesson.id] = {done:true, date:(new Date()).toLocaleDateString('pt-BR')};
  saveState();
}
function hasCompletedAll(levelId){
  var lv=findLevel(levelId);
  for(var i=0;i<lv.lessons.length;i++){
    var id=lv.lessons[i].id;
    if(!(state.progress[id] && state.progress[id].done)) return false;
  }
  return true;
}

function finishSession(){
  // badge no-skip (10 acertos seguidos sem pular)
  if(noSkipCounter>=10) state.badges._noskip10 = true;

  unlockBadges();
  saveState();

  var msg = '';
  if(mode==='lesson' && currentLesson){
    markLessonDone(currentLesson);
    msg = 'Aula conclu√≠da: '+currentLesson.name;
  }else if(mode==='challenge'){
    msg = 'Desafio conclu√≠do! (misturado)';
  }else if(mode==='coach'){
    msg = 'Treinador conclu√≠do! (foco em fraquezas)';
  }else{
    msg = 'Sess√£o conclu√≠da!';
  }

  byId('endSub').textContent = msg;

  var tips =
    '<div class="feedback ok">' +
      '<b>Resumo premium:</b>' +
      '<div class="small" style="margin-top:8px">‚Ä¢ XP total: <b>'+state.xp+'</b></div>' +
      '<div class="small">‚Ä¢ Streak: <b>'+state.streak+'</b> dia(s)</div>' +
      '<div class="small">‚Ä¢ Badges: <b>'+badgesCount()+'</b></div>' +
      '<div class="small" style="margin-top:8px"><b>Pr√≥xima a√ß√£o:</b> repita 3 frases em voz alta e volte para mais 1 sess√£o.</div>' +
    '</div>';

  byId('endCard').innerHTML = tips;

  updateHeaderStats();
  updateHomeSummary();
  renderBadgeList();
  show('end');
}

/* ===================== UI: LEVELS/LIST ===================== */
function renderLevels(){
  var box=byId('levelsList');
  box.innerHTML='<div class="small"><b>N√≠veis dispon√≠veis:</b></div>';
  for(var i=0;i<LEVELS.length;i++){
    (function(lv){
      var div=document.createElement('div');
      div.className='listItem';
      div.innerHTML =
        '<div class="title">'+lv.name+'</div>' +
        '<div class="sub">3 aulas ‚Ä¢ banco por temas ‚Ä¢ adaptativo</div>';
      div.addEventListener('click', function(){
        currentLevel=lv;
        renderLessonList(lv);
        show('lessonList');
      });
      box.appendChild(div);
    })(LEVELS[i]);
  }
}

function renderLessonList(lv){
  byId('lessonListTitle').textContent=lv.name;
  byId('lessonListSub').textContent='Escolha uma aula (cada uma gera ~12 quest√µes variadas)';
  var box=byId('lessonsList');
  box.innerHTML='';

  for(var i=0;i<lv.lessons.length;i++){
    (function(les){
      var done = state.progress[les.id] && state.progress[les.id].done;
      var div=document.createElement('div');
      div.className='listItem'+(done?' done':'');
      var stamp = done ? ('‚úÖ Conclu√≠da em '+(state.progress[les.id].date||'')) : '‚è≥ N√£o conclu√≠da';
      div.innerHTML =
        '<div class="title">'+les.name+'</div>' +
        '<div class="sub">'+les.desc+'</div>' +
        '<div class="sub">'+stamp+'</div>' +
        '<div class="sub">Temas: '+les.topics.join(', ')+'</div>';
      div.addEventListener('click', function(){
        ensureAudio();
        mode='lesson';
        currentLesson=les;
        buildLessonQueue(les);
        byId('playerTitle').textContent=les.name;
        renderQuestion();
        show('player');
      });
      box.appendChild(div);
    })(lv.lessons[i]);
  }
}

/* ===================== PLACEMENT (Premium) ===================== */
var PLACE = [];
function buildPlacement(){
  // 12 quest√µes: sobe n√≠vel e penaliza erro (de verdade)
  PLACE=[];
  var levels=['basic','pre','intermediate','preadv','adv'];
  for(var i=0;i<12;i++){
    var lv = levels[Math.min(levels.length-1, Math.floor(i/3))];
    var topic = TOPICS[Math.floor(Math.random()*TOPICS.length)];
    var skill = randomSkillByDiff(Math.min(5, 2+Math.floor(i/2)));
    var qs = genQuestionsForLevel(lv, topic, skill, Math.min(5, 2+Math.floor(i/2)));
    PLACE = PLACE.concat(qs);
  }
  PLACE = shuffle(PLACE).slice(0,12);
}
var pIdx=0, pSel=null, pScore=0;

function startPlacement(){
  mode='placement';
  buildPlacement();
  pIdx=0; pSel=null; pScore=0;
  // usa o player mesmo, mais simples e sem bug
  byId('playerTitle').textContent='Teste de n√≠vel (Premium)';
  qQueue = PLACE;
  reinforceQueue = [];
  qIndex = 0;
  selected = null;
  renderQuestion();
  show('player');
}

/* ===================== HOME / SUMMARY / BADGES ===================== */
function countDone(){
  var total=0, done=0;
  for(var i=0;i<LEVELS.length;i++){
    for(var j=0;j<LEVELS[i].lessons.length;j++){
      total++;
      var id=LEVELS[i].lessons[j].id;
      if(state.progress[id] && state.progress[id].done) done++;
    }
  }
  return {done:done,total:total};
}

function updateHeaderStats(){
  byId('xpTxt').textContent = state.xp;
  byId('streakTxt').textContent = state.streak;
  byId('badgeTxt').textContent = badgesCount();
  byId('userLevelTxt').textContent = levelNameById(state.userLevelId);
  byId('diffTxt').textContent = state.diff;
}

function updateHomeSummary(){
  var c=countDone();
  byId('progressSummary').textContent = 'Aulas conclu√≠das: '+c.done+' de '+c.total+' ‚Ä¢ XP: '+state.xp+' ‚Ä¢ Streak: '+state.streak;
}

function renderBadgeList(){
  var lines=[];
  for(var i=0;i<BADGES.length;i++){
    var b=BADGES[i];
    if(state.badges[b.id]){
      lines.push('üèÖ <b>'+b.name+'</b> ‚Äî '+state.badges[b.id].date);
    }
  }
  if(lines.length===0) lines.push('Nenhum ainda. Fa√ßa 1 sess√£o e j√° vem o primeiro üòÑ');
  byId('badgeList').innerHTML = lines.join('<br>');
}

/* ===================== EXPORT / IMPORT ===================== */
function openTransfer(modeStr){
  byId('transferBox').value = '';
  byId('doExport').onclick = function(){
    var payload = btoa(unescape(encodeURIComponent(JSON.stringify(state))));
    byId('transferBox').value = payload;
  };
  byId('doImport').onclick = function(){
    try{
      var txt = byId('transferBox').value.trim();
      if(!txt) return alert('Cole o texto primeiro.');
      var obj = JSON.parse(decodeURIComponent(escape(atob(txt))));
      if(!obj || typeof obj!=='object') throw new Error('inv√°lido');
      state = obj;
      saveState();
      updateHeaderStats();
      updateHomeSummary();
      renderBadgeList();
      alert('Importado com sucesso!');
      show('home');
    }catch(e){
      alert('Erro ao importar. Verifique se o texto est√° completo.');
    }
  };
  show('transfer');
}

/* ===================== BUTTONS / INIT ===================== */
document.addEventListener('DOMContentLoaded', function(){
  // toggles
  byId('voiceToggle').addEventListener('change', function(e){
    voiceOn=!!e.target.checked;
    try{ if(!voiceOn && window.speechSynthesis) window.speechSynthesis.cancel(); }catch(err){}
  });
  byId('sfxToggle').addEventListener('change', function(e){ sfxOn=!!e.target.checked; });
  byId('vibToggle').addEventListener('change', function(e){ vibOn=!!e.target.checked; });

  // home buttons
  byId('btnChooseLevel').addEventListener('click', function(){
    renderLevels(); show('levels');
  });

  byId('btnChallenge').addEventListener('click', function(){
    ensureAudio();
    mode='challenge';
    currentLesson=null;
    // desafio usa n√≠vel do usu√°rio
    buildChallengeQueue(state.userLevelId);
    byId('playerTitle').textContent='Desafio (misturado)';
    renderQuestion();
    show('player');
  });

  byId('btnCoach').addEventListener('click', function(){
    ensureAudio();
    mode='coach';
    currentLesson=null;
    buildCoachQueue();
    byId('playerTitle').textContent='Treinador Inteligente';
    renderQuestion();
    show('player');
  });

  byId('btnPlacement').addEventListener('click', function(){
    ensureAudio();
    startPlacement();
  });

  // back nav
  byId('backHome1').addEventListener('click', function(){ show('home'); });
  byId('backHome2').addEventListener('click', function(){ show('home'); });
  byId('backLevels').addEventListener('click', function(){ show('levels'); });
  byId('backToList').addEventListener('click', function(){
    if(currentLevel){ renderLessonList(currentLevel); show('lessonList'); }
    else show('home');
  });

  // player buttons
  byId('listenBtn').addEventListener('click', listenNow);
  byId('hintBtn').addEventListener('click', showHint);
  byId('skipBtn').addEventListener('click', skip);
  byId('checkBtn').addEventListener('click', check);
  byId('nextBtn').addEventListener('click', next);

  // end buttons
  byId('endBackBtn').addEventListener('click', function(){
    if(currentLevel){ renderLessonList(currentLevel); show('lessonList'); }
    else show('home');
  });
  byId('endHomeBtn').addEventListener('click', function(){ show('home'); });

  // reset/export/import
  byId('btnReset').addEventListener('click', function(){
    if(confirm('Zerar tudo? XP, streak, badges e progresso.')){
      localStorage.removeItem(STORE);
      location.reload();
    }
  });

  byId('btnExport').addEventListener('click', function(){ openTransfer('export'); });
  byId('btnImport').addEventListener('click', function(){ openTransfer('import'); });

  // coach from home quick start
  byId('btnCoach').addEventListener('click', function(){ ensureAudio(); });

  // update & render
  updateHeaderStats();
  updateHomeSummary();
  renderBadgeList();

  // default coach stats
  unlockBadges();
  saveState();
});
</script>
</body>
</html>