<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ingl√™s Pro - Claudio</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;background:#e0e7ff;color:#0f172a}
    .container{max-width:760px;margin:0 auto;padding:18px;min-height:100vh}
    .header{
      background:linear-gradient(135deg,#4f46e5,#2563eb);
      color:#fff;padding:18px;border-radius:20px;margin-bottom:14px;position:relative;
      box-shadow:0 18px 40px rgba(0,0,0,.14);
    }
    .header h1{font-size:1.55em;margin-bottom:6px}
    .header p{opacity:.9}
    .card{
      background:#fff;border-radius:20px;box-shadow:0 14px 30px rgba(0,0,0,.10);
      padding:18px;margin-bottom:14px
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      background:#eef2ff;color:#1e293b;border:1px solid #c7d2fe;border-radius:999px;
      padding:8px 12px;font-weight:800;font-size:.95em
    }
    .btn{
      border:none;border-radius:14px;padding:12px 14px;font-weight:900;cursor:pointer;
      transition:transform .06s ease, filter .2s ease;
      display:inline-flex;align-items:center;justify-content:center;gap:8px
    }
    .btn:active{transform:scale(.98)}
    .btn-primary{background:#4f46e5;color:#fff}
    .btn-ghost{background:#f1f5f9;color:#0f172a}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-success{background:#10b981;color:#fff}
    .btn-warning{background:#f59e0b;color:#111827}
    .btn-wide{width:100%}
    .screen{display:none}
    .screen.active{display:block}

    .level-grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:640px){ .level-grid{grid-template-columns:1fr 1fr} }

    .divider{height:1px;background:#e5e7eb;margin:14px 0}

    /* Quiz options */
    .option{
      border:2px solid #e2e8f0;background:#f8fafc;border-radius:16px;
      padding:12px 12px;cursor:pointer;transition:all .15s ease;display:flex;gap:10px;align-items:flex-start
    }
    .option:hover{filter:brightness(.98)}
    .opt-letter{
      min-width:34px;height:34px;border-radius:12px;background:#e0e7ff;color:#1e293b;
      display:flex;align-items:center;justify-content:center;font-weight:900
    }
    .option.selected{border-color:#4f46e5;background:#eef2ff}
    .option.correct{border-color:#10b981;background:#ecfdf5}
    .option.wrong{border-color:#ef4444;background:#fef2f2}

    .q-title{font-size:1.2em;font-weight:950;margin-bottom:8px}
    .q-sub{color:#475569;margin-bottom:12px;line-height:1.35}
    .tiny{font-size:.92em;color:#64748b}

    .progressWrap{background:#eef2ff;border-radius:999px;overflow:hidden;height:12px;border:1px solid #c7d2fe}
    .progressBar{height:12px;background:#4f46e5;width:0%}

    .hintBox{background:#fff7ed;border:2px solid #fdba74;border-radius:16px;padding:12px;color:#7c2d12}
    .explainBox{background:#eff6ff;border:2px solid #93c5fd;border-radius:16px;padding:12px;color:#1e3a8a}
    .goodBox{background:#ecfdf5;border:2px solid #10b981;border-radius:16px;padding:12px;color:#14532d}
    .badBox{background:#fef2f2;border:2px solid #ef4444;border-radius:16px;padding:12px;color:#7f1d1d}

    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px}

    .flash{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .18s ease}
    .flash.on{opacity:.18}
    .flash.good{background:#22c55e}
    .flash.bad{background:#ef4444}

    .input{
      width:100%;padding:14px;border-radius:16px;border:2px solid #d1d5db;
      font-size:1.05em;outline:none
    }
    .input:focus{border-color:#4f46e5}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;font-weight:900;font-size:.9em;
      border:1px solid #e5e7eb;background:#f8fafc;color:#0f172a
    }
  </style>
</head>
<body>
  <div class="flash" id="flash"></div>

  <div class="container">
    <!-- HOME -->
    <div id="homeScreen" class="screen active">
      <div class="header">
        <h1>üéØ Ingl√™s Pro</h1>
        <p>Aula com teoria + pr√°tica (B√°sico ‚Üí Pr√©-Intermedi√°rio)</p>
      </div>

      <div class="card">
        <div class="row" style="margin-bottom:10px">
          <div class="pill" id="streakPill">üî• Streak: 0</div>
          <div class="pill" id="xpPill">‚≠ê XP: 0</div>
          <div class="pill" id="accuracyPill">üéØ Acerto: 0%</div>
        </div>

        <div class="level-grid">
          <button class="btn btn-primary btn-wide" onclick="startLesson('basic')">üìò Aula B√°sico (A1)</button>
          <button class="btn btn-primary btn-wide" onclick="startLesson('preintermediate')">üìó Aula Pr√©-Intermedi√°rio (A2)</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn btn-ghost" onclick="openStats()">üìä Progresso</button>
          <button class="btn btn-danger" onclick="resetAll()">üß® Resetar tudo</button>
        </div>

        <p class="tiny" style="margin-top:10px">
          Nesta vers√£o, cada aula mistura: <strong>Teoria curta</strong> ‚Üí <strong>Quiz A‚ÄìE</strong> ‚Üí <strong>Escrita flex√≠vel</strong> ‚Üí <strong>Escrita exata</strong>.
        </p>
      </div>
    </div>

    <!-- STATS -->
    <div id="statsScreen" class="screen">
      <div class="header">
        <h1>üìä Seu Progresso</h1>
        <p>Resumo do que voc√™ j√° fez</p>
      </div>
      <div class="card" id="statsBox"></div>
      <div class="card">
        <button class="btn btn-primary btn-wide" onclick="goHome()">‚Üê Voltar</button>
      </div>
    </div>

    <!-- LESSON -->
    <div id="lessonScreen" class="screen">
      <div class="header">
        <h1 id="lessonHeader">üìò Aula</h1>
        <p id="lessonSub">Teoria + pr√°tica + escrita</p>
      </div>

      <div class="card">
        <div class="topbar">
          <div style="min-width:240px">
            <div class="tiny" id="stepCounter">Etapa 1/4</div>
            <div class="progressWrap">
              <div class="progressBar" id="progressBar"></div>
            </div>
          </div>

          <div class="row">
            <button class="btn btn-ghost" onclick="confirmEndPartial()">‚è∏ Encerrar parcial</button>
            <button class="btn btn-danger" onclick="confirmExitHome()">üè† In√≠cio</button>
          </div>
        </div>

        <div class="divider"></div>

        <div id="contentArea"></div>

        <div class="divider"></div>

        <div class="row" id="actionRow">
          <!-- bot√µes din√¢micos -->
        </div>

        <p class="tiny" id="footerTip" style="margin-top:10px"></p>
      </div>
    </div>

  </div>

<script>
/* =========================
   STORAGE
========================= */
const STORE_KEY = "inglesPro_v4";
const LETTERS = ["A","B","C","D","E"];

function loadState(){
  try{ return JSON.parse(localStorage.getItem(STORE_KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveState(patch){
  const s = loadState();
  const merged = { ...s, ...patch };
  localStorage.setItem(STORE_KEY, JSON.stringify(merged));
  return merged;
}
function todayKey(){ return new Date().toLocaleDateString("pt-BR"); }
function calcAccuracy(state){
  const c = state.totalCorrect||0;
  const w = state.totalWrong||0;
  const t = c+w;
  return t ? Math.round((c/t)*100) : 0;
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

/* =========================
   AUDIO (TTS)
========================= */
function speak(text, rate=0.9){
  if(!("speechSynthesis" in window)) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.rate = rate;
  speechSynthesis.speak(u);
}

/* =========================
   SFX
========================= */
let audioCtx = null;
function beep(type){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    const t0 = ctx.currentTime;

    if(type==="good"){
      o.type="sine";
      o.frequency.setValueAtTime(880,t0);
      o.frequency.exponentialRampToValueAtTime(1320,t0+0.08);
      g.gain.setValueAtTime(0.001,t0);
      g.gain.exponentialRampToValueAtTime(0.12,t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.001,t0+0.18);
      o.start(t0); o.stop(t0+0.20);
    }else{
      o.type="square";
      o.frequency.setValueAtTime(220,t0);
      o.frequency.exponentialRampToValueAtTime(110,t0+0.10);
      g.gain.setValueAtTime(0.001,t0);
      g.gain.exponentialRampToValueAtTime(0.16,t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.001,t0+0.22);
      o.start(t0); o.stop(t0+0.24);
    }
  }catch(e){}
}
function flash(type){
  const el = document.getElementById("flash");
  el.className = "flash " + (type==="good" ? "good" : "bad");
  requestAnimationFrame(()=> el.classList.add("on"));
  setTimeout(()=> el.classList.remove("on"), 160);
}

/* =========================
   BANKS (B√°sico + Pr√©)
   - Quiz (A‚ÄìE)
   - Writing (flex√≠vel + exata)
========================= */
const LESSONS = {
  basic: {
    title: "üìò B√°sico (A1)",
    theory: [
      { title:"Padr√£o #1 (o mais importante)",
        text:"Com I / You / We / They, o verbo fica na forma base (work, help, live). Com He / She / It, o verbo ganha -s (works, helps, lives).",
        examples:["I work here.","She works here."],
        common:"Erro comum: ‚ÄúI works‚Ä¶‚Äù (n√£o)."
      },
      { title:"Padr√£o #2 (negativa e pergunta)",
        text:"No Present Simple, a negativa e a pergunta usam DO/DOES. Depois do DO/DOES, o verbo volta para a forma base.",
        examples:["I do not like coffee.","Does he work here?"],
        common:"Erro comum: ‚ÄúDoes he works?‚Äù (n√£o)."
      }
    ],
    quiz: [
      { id:"B01", promptPT:"Escolha a frase correta para o ambiente de trabalho.", audio:"I help my team.",
        options:["I help my team.","I helps my team.","I helping my team.","I helped my team every day.","I am help my team."],
        correctIndex:0, hint:"Observe quem faz a a√ß√£o (I / he / she / they).",
        explain:"Com I, o verbo fica na forma base (help), sem ‚Äús‚Äù."
      },
      { id:"B02", promptPT:"O que essa frase significa?", audio:"I wake up early.",
        options:["Eu acordo cedo.","Eu acordei cedo ontem.","Eu estou acordando agora.","Eu vou acordar cedo amanh√£.","Eu estava acordando cedo."],
        correctIndex:0, hint:"A frase fala de h√°bito ou de um momento espec√≠fico?",
        explain:"Presente simples geralmente indica rotina/h√°bito."
      },
      { id:"B03", promptPT:"Como voc√™ diz que n√£o gosta de caf√©?", audio:"I do not like coffee.",
        options:["I not like coffee.","I do not like coffee.","I no like coffee.","I am not like coffee.","I don't likes coffee."],
        correctIndex:1, hint:"Negativa no presente usa do/does.",
        explain:"I do not (don‚Äôt) + verbo base."
      },
      { id:"B04", promptPT:"Como voc√™ pergunta se a pessoa estuda ingl√™s?", audio:"Do you study English?",
        options:["You study English?","Are you study English?","Do you study English?","Does you study English?","Do you studies English?"],
        correctIndex:2, hint:"Pergunta no presente: do/does + sujeito + verbo base.",
        explain:"Com You usamos DO."
      },
      { id:"B05", promptPT:"Escolha a frase correta.", audio:"She works at the office.",
        options:["She work at the office.","She works at the office.","She working at the office.","She worked at the office every day.","She is work at the office."],
        correctIndex:1, hint:"He/She/It pede verbo com -s.",
        explain:"She ‚Üí works."
      }
    ],
    writing: [
      // FLEX√çVEL
      {
        id:"BW_F1",
        mode:"flex",
        title:"‚úçÔ∏è Escreva a frase (flex√≠vel)",
        promptPT:"Voc√™ est√° no trabalho. Escreva em ingl√™s: ‚ÄúEu ajudo meu time.‚Äù",
        target:"I help my team.",
        audio:"I help my team.",
        hint:"Dica: comece com ‚ÄúI‚Äù e use o verbo na base (sem s)."
      },
      // EXATA
      {
        id:"BW_E1",
        mode:"exact",
        title:"üéØ Escreva exatamente assim",
        promptPT:"Digite exatamente a frase abaixo (incluindo pontua√ß√£o):",
        target:"I help my team.",
        audio:"I help my team.",
        hint:"Dica: copie a frase com o ponto final."
      }
    ]
  },

  preintermediate: {
    title: "üìó Pr√©-Intermedi√°rio (A2)",
    theory: [
      { title:"Simple x Continuous (agora vs rotina)",
        text:"Right now / now / at the moment ‚Üí Present Continuous (am/is/are + -ing). Every day / usually / on Mondays ‚Üí Present Simple.",
        examples:["I am studying right now.","I study English every day."],
        common:"Erro comum: ‚ÄúI am study‚Ä¶‚Äù (falta -ing)."
      },
      { title:"Perguntas √∫teis (viagem e vida real)",
        text:"Com ‚Äòto be‚Äô (is/are) voc√™ n√£o usa do/does. Com verbos normais, use do/does.",
        examples:["Where is the bathroom?","How much does it cost?"],
        common:"Erro comum: ‚ÄúWhere does the bathroom is?‚Äù (n√£o)."
      }
    ],
    quiz: [
      { id:"P01", promptPT:"Voc√™ est√° falando do que est√° acontecendo AGORA. Qual frase est√° correta?", audio:"I am studying right now.",
        options:["I am studying right now.","I study right now.","I studying right now.","I am study right now.","I studied right now."],
        correctIndex:0, hint:"Right now indica a√ß√£o em progresso.",
        explain:"Present Continuous: am/is/are + -ing."
      },
      { id:"P02", promptPT:"Rotina/h√°bito. Qual frase est√° correta?", audio:"I study English every day.",
        options:["I am studying English every day.","I study English every day.","I studies English every day.","I studying English every day.","I study English yesterday."],
        correctIndex:1, hint:"Every day = h√°bito.",
        explain:"H√°bito ‚Üí Present Simple."
      },
      { id:"P03", promptPT:"Qual pergunta est√° correta para perguntar ONDE fica o banheiro?", audio:"Where is the bathroom?",
        options:["Where the bathroom is?","Where is the bathroom?","Where does the bathroom is?","Where are the bathroom?","Where is bathroom?"],
        correctIndex:1, hint:"Com ‚Äòto be‚Äô, n√£o usamos do/does.",
        explain:"Where + is/are + sujeito."
      },
      { id:"P04", promptPT:"Voc√™ foi ao cinema ontem. Qual frase est√° correta?", audio:"I went to the cinema yesterday.",
        options:["I go to the cinema yesterday.","I went to the cinema yesterday.","I goed to the cinema yesterday.","I was go to the cinema yesterday.","I am going to the cinema yesterday."],
        correctIndex:1, hint:"Yesterday = passado.",
        explain:"Past Simple irregular: go ‚Üí went."
      },
      { id:"P05", promptPT:"Pre√ßo: qual pergunta est√° correta?", audio:"How much does it cost?",
        options:["How much it costs?","How much does it cost?","How much do it cost?","How much does it costs?","How many does it cost?"],
        correctIndex:1, hint:"It (singular) ‚Üí does + verbo base.",
        explain:"Does + cost (base)."
      }
    ],
    writing: [
      { id:"PW_F1", mode:"flex",
        title:"‚úçÔ∏è Escreva a frase (flex√≠vel)",
        promptPT:"Escreva em ingl√™s: ‚ÄúEu estou estudando agora.‚Äù",
        target:"I am studying now.",
        audio:"I am studying now.",
        hint:"Dica: use am + verbo com -ing."
      },
      { id:"PW_E1", mode:"exact",
        title:"üéØ Escreva exatamente assim",
        promptPT:"Digite exatamente a frase abaixo (incluindo pontua√ß√£o):",
        target:"I am studying right now.",
        audio:"I am studying right now.",
        hint:"Dica: right now = agora. Copie certinho."
      }
    ]
  }
};

/* =========================
   SESSION STATE
========================= */
let session = {
  levelKey: null,
  stepIndex: 0,      // 0 teoria, 1 quiz, 2 writing flex, 3 writing exact, 4 result
  quizOrder: [],
  quizPos: 0,
  currentQuiz: null,
  shuffledOptions: [],
  correctText: "",
  selectedIndex: null,
  locked: false,
  usedHint: false,

  // writing
  currentWriting: null,
  userText: "",
  writingChecked: false,

  // scoring
  correct: 0,
  wrong: 0
};

/* =========================
   SCREENS
========================= */
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}
function renderHomePills(){
  const s = loadState();
  document.getElementById("streakPill").textContent = `üî• Streak: ${s.streak||0}`;
  document.getElementById("xpPill").textContent = `‚≠ê XP: ${s.xp||0}`;
  document.getElementById("accuracyPill").textContent = `üéØ Acerto: ${calcAccuracy(s)}%`;
}
function goHome(){
  renderHomePills();
  showScreen("homeScreen");
}
function openStats(){
  const s = loadState();
  const statsBox = document.getElementById("statsBox");
  const basic = s.basic || {};
  const pre = s.preintermediate || {};
  statsBox.innerHTML = `
    <div class="row" style="margin-bottom:12px">
      <div class="pill">üî• Streak: ${s.streak||0}</div>
      <div class="pill">‚≠ê XP: ${s.xp||0}</div>
      <div class="pill">üéØ Acerto: ${calcAccuracy(s)}%</div>
    </div>

    <div class="divider"></div>

    <p style="font-weight:950;margin-bottom:6px">üìò B√°sico</p>
    <p class="tiny">Aulas conclu√≠das: <strong>${(basic.completedSessions||0)}</strong> ‚Ä¢ Melhor acerto: <strong>${(basic.bestAcc||0)}%</strong></p>

    <div class="divider"></div>

    <p style="font-weight:950;margin-bottom:6px">üìó Pr√©-Intermedi√°rio</p>
    <p class="tiny">Aulas conclu√≠das: <strong>${(pre.completedSessions||0)}</strong> ‚Ä¢ Melhor acerto: <strong>${(pre.bestAcc||0)}%</strong></p>
  `;
  showScreen("statsScreen");
}
function resetAll(){
  const ok = confirm("Tem certeza que quer resetar TUDO?");
  if(!ok) return;
  localStorage.removeItem(STORE_KEY);
  renderHomePills();
  alert("Resetado ‚úÖ");
}
function confirmExitHome(){
  const ok = confirm("Voltar ao in√≠cio agora? (a aula atual reinicia)");
  if(ok) goHome();
}
function confirmEndPartial(){
  const ok = confirm("Encerrar parcial e voltar ao in√≠cio?");
  if(ok) goHome();
}

/* =========================
   START LESSON
========================= */
function startLesson(levelKey){
  const L = LESSONS[levelKey];
  if(!L) return alert("N√≠vel n√£o encontrado.");

  session.levelKey = levelKey;
  session.stepIndex = 0;

  session.correct = 0;
  session.wrong = 0;

  // quiz order
  session.quizOrder = shuffle(L.quiz);
  session.quizPos = 0;
  session.currentQuiz = null;
  session.shuffledOptions = [];
  session.correctText = "";
  session.selectedIndex = null;
  session.locked = false;
  session.usedHint = false;

  // writing
  session.currentWriting = null;
  session.userText = "";
  session.writingChecked = false;

  document.getElementById("lessonHeader").textContent = L.title;
  document.getElementById("lessonSub").textContent = "Teoria curta ‚Üí quiz ‚Üí escrita (flex + exata)";

  renderStep();
  showScreen("lessonScreen");
}

/* =========================
   PROGRESS BAR + COUNTERS
========================= */
function setProgress(){
  // Steps: 0 theory, 1 quiz, 2 writing flex, 3 writing exact, 4 result
  const totalSteps = 5;
  const step = clamp(session.stepIndex+1, 1, totalSteps);
  document.getElementById("stepCounter").textContent = `Etapa ${step}/${totalSteps}`;
  document.getElementById("progressBar").style.width = `${Math.round(((step-1)/(totalSteps))*100)}%`;
}

/* =========================
   STEP RENDER
========================= */
function renderStep(){
  setProgress();

  const L = LESSONS[session.levelKey];
  const area = document.getElementById("contentArea");
  const actions = document.getElementById("actionRow");
  const footer = document.getElementById("footerTip");
  area.innerHTML = "";
  actions.innerHTML = "";
  footer.textContent = "";

  if(session.stepIndex === 0){
    // THEORY
    const blocks = L.theory.map((t, idx)=>`
      <div class="card" style="box-shadow:none;border:2px solid #e5e7eb;background:#fafafa;margin-bottom:10px">
        <div class="row" style="justify-content:space-between">
          <div style="font-weight:950">${idx+1}) ${t.title}</div>
          <span class="badge">üé¨ microaula</span>
        </div>
        <div style="margin-top:8px;line-height:1.45;color:#0f172a">${t.text}</div>
        <div class="divider"></div>
        <div class="tiny"><strong>Exemplos:</strong> ${t.examples.join(" ‚Ä¢ ")}</div>
        <div class="tiny" style="margin-top:6px"><strong>Erro comum:</strong> ${t.common}</div>
      </div>
    `).join("");

    area.innerHTML = `
      <div class="q-title">üìö Teoria r√°pida (1 minuto)</div>
      <div class="q-sub">Leia e ou√ßa exemplos. Depois voc√™ vai pra pr√°tica.</div>
      ${blocks}
      <div class="row">
        <button class="btn btn-ghost" onclick="speakTheoryExamples()">üîä Ouvir exemplos</button>
      </div>
    `;

    actions.innerHTML = `
      <button class="btn btn-primary" onclick="goNextStep()">üöÄ Ir para o Quiz</button>
    `;
    footer.textContent = "Meta: entender o padr√£o ‚Äî n√£o decorar regra.";
    return;
  }

  if(session.stepIndex === 1){
    // QUIZ
    renderQuizQuestion();
    return;
  }

  if(session.stepIndex === 2){
    // WRITING FLEX
    session.currentWriting = L.writing.find(w=>w.mode==="flex");
    renderWriting();
    return;
  }

  if(session.stepIndex === 3){
    // WRITING EXACT
    session.currentWriting = L.writing.find(w=>w.mode==="exact");
    renderWriting();
    return;
  }

  if(session.stepIndex === 4){
    // RESULT
    const total = session.correct + session.wrong;
    const acc = total ? Math.round((session.correct/total)*100) : 0;

    area.innerHTML = `
      <div class="q-title">‚úÖ Aula conclu√≠da!</div>
      <div class="row" style="margin:10px 0">
        <div class="pill">üéØ Acerto: ${acc}%</div>
        <div class="pill">‚úÖ Certas: ${session.correct}</div>
        <div class="pill">‚ùå Erradas: ${session.wrong}</div>
      </div>
      <div class="divider"></div>
      <div class="q-sub">
        Agora voc√™ est√° pronto pra repetir a aula e melhorar a precis√£o.
        O ideal √©: <strong>acerto acima de 80%</strong> antes de subir de n√≠vel.
      </div>
    `;

    actions.innerHTML = `
      <button class="btn btn-primary" onclick="finishLesson()">üèÅ Salvar e voltar ao in√≠cio</button>
    `;
    footer.textContent = "Se quiser, eu adiciono ‚Äúrevis√£o de erros‚Äù automaticamente no final.";
    return;
  }
}

function goNextStep(){
  session.stepIndex++;
  renderStep();
}

/* =========================
   THEORY AUDIO
========================= */
function speakTheoryExamples(){
  const L = LESSONS[session.levelKey];
  const all = [];
  L.theory.forEach(t => t.examples.forEach(e=>all.push(e)));
  speak(all.join(" ... "), 0.9);
}

/* =========================
   QUIZ LOGIC
========================= */
function buildShuffledQuiz(q){
  const correctText = q.options[q.correctIndex];
  let opts = shuffle(q.options);

  // Anti "cair sempre na A": se cair na mesma letra 2x seguidas, tenta um reshuffle
  if(!session._lastCorrectLetters) session._lastCorrectLetters = [];
  let idx = opts.indexOf(correctText);
  let letter = LETTERS[idx] || "A";
  const last2 = session._lastCorrectLetters.slice(-2);
  if(last2.length===2 && last2[0]===letter && last2[1]===letter){
    const resh = shuffle(q.options);
    opts = resh;
    idx = opts.indexOf(correctText);
    letter = LETTERS[idx] || "A";
  }
  session._lastCorrectLetters.push(letter);

  return { ...q, _correctText: correctText, _opts: opts };
}

function renderQuizQuestion(){
  const L = LESSONS[session.levelKey];
  const area = document.getElementById("contentArea");
  const actions = document.getElementById("actionRow");
  const footer = document.getElementById("footerTip");

  if(session.quizPos >= session.quizOrder.length){
    // terminou quiz
    goNextStep();
    return;
  }

  session.locked = false;
  session.usedHint = false;
  session.selectedIndex = null;

  const qRaw = session.quizOrder[session.quizPos];
  const q = buildShuffledQuiz(qRaw);
  session.currentQuiz = q;

  area.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <div class="q-title">üß† Quiz A‚ÄìE (${session.quizPos+1}/${session.quizOrder.length})</div>
        <div class="q-sub"><strong>Pergunta (PT):</strong> ${q.promptPT}</div>
      </div>
      <span class="badge">‚ö° r√°pido</span>
    </div>

    <div class="row" style="margin:8px 0">
      <button class="btn btn-ghost" onclick="speak('${escapeJS(q.audio)}', 0.9)">üîä Ouvir</button>
      <button class="btn btn-ghost" onclick="speak('${escapeJS(q.audio)}', 0.75)">üê¢ Devagar</button>
      <button class="btn btn-warning" onclick="showHintQuiz()">üí° Dica</button>
    </div>

    <div id="hintBox" style="display:none" class="hintBox"></div>
    <div id="optionsBox" style="display:grid;gap:10px;margin-top:10px"></div>
    <div id="feedbackBox" style="display:none;margin-top:12px"></div>
  `;

  const optsBox = document.getElementById("optionsBox");
  q._opts.forEach((text, idx)=>{
    const div = document.createElement("div");
    div.className = "option";
    div.onclick = ()=> selectOptionQuiz(idx);
    div.innerHTML = `
      <div class="opt-letter">${LETTERS[idx]}</div>
      <div style="flex:1">
        <div style="font-weight:950">${text}</div>
      </div>
    `;
    optsBox.appendChild(div);
  });

  actions.innerHTML = `
    <button class="btn btn-primary" id="checkBtn" onclick="checkQuiz()">‚úÖ Verificar</button>
    <button class="btn btn-primary" id="nextBtn" style="display:none" onclick="nextQuiz()">‚û°Ô∏è Pr√≥xima</button>
  `;

  footer.textContent = "Dica boa n√£o entrega a resposta ‚Äî ela aponta o padr√£o.";
}

function escapeJS(s){
  return String(s).replace(/\\/g,"\\\\").replace(/'/g,"\\'");
}

function showHintQuiz(){
  const q = session.currentQuiz;
  session.usedHint = true;
  const box = document.getElementById("hintBox");
  box.style.display = "block";
  box.innerHTML = `<strong>üí° Dica:</strong> ${q.hint}`;
}

function selectOptionQuiz(idx){
  if(session.locked) return;
  session.selectedIndex = idx;
  const children = [...document.getElementById("optionsBox").children];
  children.forEach((c,i)=> c.classList.toggle("selected", i===idx));
}

function checkQuiz(){
  if(session.locked) return;

  if(session.selectedIndex===null){
    alert("Selecione uma alternativa primeiro üòâ");
    return;
  }

  session.locked = true;

  const q = session.currentQuiz;
  const correctText = q._correctText;
  const chosenText = q._opts[session.selectedIndex];
  const ok = chosenText === correctText;

  const optionsEls = [...document.getElementById("optionsBox").children];
  optionsEls.forEach((el, idx)=>{
    const t = q._opts[idx];
    if(t === correctText) el.classList.add("correct");
    if(idx === session.selectedIndex && !ok) el.classList.add("wrong");
  });

  const fb = document.getElementById("feedbackBox");
  fb.style.display = "block";
  fb.className = ok ? "goodBox" : "badBox";
  fb.innerHTML = `
    <div style="font-weight:950;margin-bottom:6px">${ok ? "‚úÖ Correto!" : "‚ùå Quase!"}</div>
    <div class="tiny" style="margin-bottom:6px"><strong>Frase (EN):</strong> ${q.audio}</div>
    <div><strong>Por qu√™:</strong> ${q.explain}</div>
  `;

  if(ok){
    session.correct++;
    beep("good"); flash("good");
    addXP(10);
  }else{
    session.wrong++;
    beep("bad"); flash("bad");
    addXP(2);

    // errou? deixa o quiz mais "din√¢mico": troca a pr√≥xima quest√£o por outra aleat√≥ria do banco
    // (sem repetir a mesma imediatamente)
    const L = LESSONS[session.levelKey];
    const pool = L.quiz.filter(x => x.id !== q.id);
    if(pool.length){
      const swap = pool[Math.floor(Math.random()*pool.length)];
      session.quizOrder[session.quizPos] = swap; // substitui a atual para ‚Äún√£o travar‚Äù
    }
  }

  document.getElementById("checkBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "inline-flex";
}

function nextQuiz(){
  session.quizPos++;
  renderQuizQuestion();
}

/* =========================
   WRITING (FLEX + EXACT)
========================= */
function normalizeText(s){
  return String(s)
    .trim()
    .toLowerCase()
    .replace(/[‚Äú‚Äù"]/g,'"')
    .replace(/[‚Äô]/g,"'")
    .replace(/\s+/g," ")
    .replace(/[!?]/g,"") // n√£o tira ponto aqui, pq no exato a gente compara com pontua√ß√£o
    ;
}

function stripPunctuation(s){
  return String(s).replace(/[.,;:]/g,"").trim();
}

// avalia√ß√£o flex√≠vel: pontua por padr√µes essenciais
function evalFlexible(user, target){
  const u0 = normalizeText(user);
  const t0 = normalizeText(target);

  const u = stripPunctuation(u0);
  const t = stripPunctuation(t0);

  // crit√©rios simples (expans√≠veis)
  const res = { ok:false, score:0, max:4, notes:[] };

  // 1) mesmas palavras-chave (conjunto m√≠nimo)
  const mustWords = t.split(" ").filter(Boolean);

  // regra: aceita se tiver >= 70% das palavras alvo na resposta
  const uw = new Set(u.split(" ").filter(Boolean));
  let hit = 0;
  mustWords.forEach(w=>{ if(uw.has(w)) hit++; });

  const ratio = mustWords.length ? (hit/mustWords.length) : 0;
  if(ratio >= 0.70){ res.score++; } else {
    res.notes.push("Faltaram palavras importantes da frase.");
  }

  // 2) ordem b√°sica (come√ßar com sujeito esperado se existir)
  const tFirst = mustWords[0];
  const uFirst = u.split(" ")[0] || "";
  if(tFirst && uFirst === tFirst){ res.score++; }
  else res.notes.push("A frase geralmente come√ßa com o sujeito (I / She / They...).");

  // 3) auxiliar quando existir no target
  if(t.includes(" do not ") || t.includes(" don't ")){
    if(u.includes("do not") || u.includes("don't")) res.score++;
    else res.notes.push("Negativa no presente precisa de DO + NOT (ou DON'T).");
  } else if(t.includes(" does not ") || t.includes(" doesn't ")){
    if(u.includes("does not") || u.includes("doesn't")) res.score++;
    else res.notes.push("Com he/she/it, a negativa usa DOESN'T.");
  } else {
    // se n√£o √© negativa, d√° ponto por ‚Äún√£o usar auxiliar errado‚Äù
    if(!(u.includes("does") && u.includes("works"))){ res.score++; }
    else res.notes.push("Cuidado: se usar DOES, o verbo fica na base (work).");
  }

  // 4) verbo com -ing quando o target tiver -ing
  if(t.includes("ing")){
    if(u.includes("ing")) res.score++;
    else res.notes.push("Aqui √© a√ß√£o em progresso: use verbo com -ing.");
  }else{
    // se target n√£o tem ing, penaliza ing desnecess√°rio s√≥ se atrapalhar
    res.score++;
  }

  res.ok = res.score >= 3; // passa com 3/4
  return res;
}

function evalExact(user, target){
  // exato: compara normalizado mas mantendo ponto final e v√≠rgula
  const u = String(user).trim();
  const t = String(target).trim();
  // permite diferen√ßa de espa√ßos
  const u2 = u.replace(/\s+/g," ");
  const t2 = t.replace(/\s+/g," ");
  return { ok: u2 === t2 };
}

function renderWriting(){
  const area = document.getElementById("contentArea");
  const actions = document.getElementById("actionRow");
  const footer = document.getElementById("footerTip");
  const w = session.currentWriting;

  session.userText = "";
  session.writingChecked = false;

  const tag = w.mode === "flex"
    ? `<span class="badge">üß† flex√≠vel</span>`
    : `<span class="badge">üéØ exata</span>`;

  area.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:flex-start">
      <div>
        <div class="q-title">${w.title}</div>
        <div class="q-sub">${w.promptPT}</div>
      </div>
      ${tag}
    </div>

    <div class="row" style="margin:8px 0">
      <button class="btn btn-ghost" onclick="speak('${escapeJS(w.audio)}', 0.9)">üîä Ouvir</button>
      <button class="btn btn-ghost" onclick="speak('${escapeJS(w.audio)}', 0.75)">üê¢ Devagar</button>
      <button class="btn btn-warning" onclick="showHintWriting()">üí° Dica</button>
    </div>

    <div id="hintBoxW" style="display:none" class="hintBox"></div>

    <div class="divider"></div>

    ${w.mode==="exact" ? `
      <div class="tiny" style="margin-bottom:8px"><strong>Frase-alvo:</strong> ${w.target}</div>
    ` : `
      <div class="tiny" style="margin-bottom:8px"><strong>Meta:</strong> escrever com o padr√£o correto (varia√ß√µes s√£o aceitas).</div>
    `}

    <input id="writingInput" class="input" placeholder="Digite sua resposta..." />

    <div id="writingFeedback" style="display:none;margin-top:12px"></div>
  `;

  actions.innerHTML = `
    <button class="btn btn-primary" onclick="checkWriting()">‚úÖ Verificar</button>
    <button class="btn btn-primary" id="nextWritingBtn" style="display:none" onclick="nextWriting()">‚û°Ô∏è Pr√≥xima</button>
  `;

  footer.textContent = w.mode==="exact"
    ? "Modo exato: aqui √© para treinar precis√£o (como se fosse prova)."
    : "Modo flex√≠vel: aqui √© para ganhar flu√™ncia com feedback inteligente.";
}

function showHintWriting(){
  const w = session.currentWriting;
  const box = document.getElementById("hintBoxW");
  box.style.display = "block";
  box.innerHTML = `<strong>üí° Dica:</strong> ${w.hint}`;
}

function checkWriting(){
  const w = session.currentWriting;
  const input = document.getElementById("writingInput");
  const text = input.value;
  if(!text.trim()){
    alert("Digite alguma coisa üòâ");
    return;
  }

  let result;
  if(w.mode==="exact"){
    result = evalExact(text, w.target);
  }else{
    result = evalFlexible(text, w.target);
  }

  const fb = document.getElementById("writingFeedback");
  fb.style.display = "block";

  if(result.ok){
    session.correct++;
    beep("good"); flash("good");
    addXP(w.mode==="exact" ? 14 : 12);

    fb.className = "goodBox";
    fb.innerHTML = `
      <div style="font-weight:950;margin-bottom:6px">‚úÖ Bom! Voc√™ acertou.</div>
      <div class="tiny" style="margin-bottom:8px"><strong>Resposta sugerida:</strong> ${w.target}</div>
      ${w.mode==="flex" ? `<div class="tiny">√ìtimo: voc√™ usou o padr√£o principal.</div>` : `<div class="tiny">Perfeito: exato como precisa.</div>`}
    `;
  }else{
    session.wrong++;
    beep("bad"); flash("bad");
    addXP(3);

    fb.className = "badBox";
    if(w.mode==="exact"){
      fb.innerHTML = `
        <div style="font-weight:950;margin-bottom:6px">‚ùå Quase! (modo exato)</div>
        <div class="tiny" style="margin-bottom:8px"><strong>O correto √©:</strong> ${w.target}</div>
        <div class="tiny">Dica: copie exatamente, inclusive o ponto final.</div>
      `;
    }else{
      const notes = (result.notes||[]).slice(0,3).map(n=>`<li>${n}</li>`).join("");
      fb.innerHTML = `
        <div style="font-weight:950;margin-bottom:6px">‚ùå Quase! (modo flex√≠vel)</div>
        <div class="tiny" style="margin-bottom:8px"><strong>Resposta sugerida:</strong> ${w.target}</div>
        <div class="tiny" style="margin-bottom:6px"><strong>O que melhorar:</strong></div>
        <ul class="tiny" style="margin-left:18px;line-height:1.4">${notes || "<li>Use o padr√£o da teoria.</li>"}</ul>
      `;
    }
  }

  document.getElementById("nextWritingBtn").style.display = "inline-flex";
}

function nextWriting(){
  // depois do flex vai pro exact, depois do exact vai pro result
  goNextStep();
}

/* =========================
   XP + GLOBAL STATS
========================= */
function addXP(points){
  const s = loadState();
  const xp = (s.xp||0) + points;
  const totalCorrect = (s.totalCorrect||0) + 0; // atualizado no finish
  const totalWrong = (s.totalWrong||0) + 0;
  saveState({ xp, totalCorrect, totalWrong });
}

/* =========================
   FINISH LESSON
========================= */
function finishLesson(){
  const s = loadState();
  const today = todayKey();

  // streak simples (1 por dia)
  let streak = s.streak || 0;
  if(s.lastDay !== today) streak++;

  const total = session.correct + session.wrong;
  const acc = total ? Math.round((session.correct/total)*100) : 0;

  // stats por n√≠vel
  const key = session.levelKey;
  const level = s[key] || {};
  const completedSessions = (level.completedSessions||0) + 1;
  const bestAcc = Math.max(level.bestAcc||0, acc);

  // atualiza globais de acerto/erro
  const totalCorrect = (s.totalCorrect||0) + session.correct;
  const totalWrong = (s.totalWrong||0) + session.wrong;

  saveState({
    streak,
    lastDay: today,
    totalCorrect,
    totalWrong,
    [key]: { ...level, completedSessions, bestAcc }
  });

  alert(`‚úÖ Aula salva!\nAcerto: ${acc}%\nCertas: ${session.correct}\nErradas: ${session.wrong}`);
  goHome();
}

/* =========================
   NAV
========================= */
renderHomePills();
</script>
</body>
</html>