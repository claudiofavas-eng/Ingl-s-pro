<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>English Trainer â€¢ NÃ­veis</title>

<style>
  :root{
    --bg:#0f1115;
    --card:#171a21;
    --muted:#9aa3b2;
    --btn:#2a2f3a;
    --btn2:#3a4152;
    --good:#1f7a1f;
    --bad:#8b1e1e;
    --warn:#f59e0b;
    --accent:#4f46e5;
    --border:#262b36;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background: radial-gradient(1000px 600px at 20% 0%, #1d2140 0%, transparent 60%),
                radial-gradient(900px 600px at 90% 10%, #2b1248 0%, transparent 60%),
                var(--bg);
    color:#fff;
    padding:18px;
  }
  .wrap{max-width:920px;margin:0 auto}
  .top{
    display:flex;gap:10px;align-items:center;justify-content:space-between;
    margin-bottom:14px;flex-wrap:wrap;
  }
  .brand{display:flex;flex-direction:column;gap:2px}
  .brand h1{margin:0;font-size:18px}
  .brand small{color:var(--muted)}
  .pill{
    background:#0b0d12;border:1px solid var(--border);
    padding:8px 10px;border-radius:999px;color:var(--muted);
    font-size:12px;
  }

  .card{
    background: rgba(23,26,33,.92);
    border:1px solid var(--border);
    border-radius:16px;
    box-shadow: 0 18px 40px rgba(0,0,0,.35);
    padding:16px;
  }

  .screen{display:none}
  .screen.active{display:block}

  .grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:10px;
    margin-top:10px;
  }
  @media (max-width:700px){
    .grid{grid-template-columns:1fr}
  }

  button{
    border:none;
    cursor:pointer;
    border-radius:12px;
    padding:10px 12px;
    font-size:14px;
    color:#fff;
    background:var(--btn);
    transition:.15s transform, .15s background;
    user-select:none;
  }
  button:hover{background:var(--btn2)}
  button:active{transform:scale(.98)}
  .btn-accent{background:var(--accent)}
  .btn-accent:hover{background:#3f37d8}
  .btn-ghost{
    background:transparent;
    border:1px solid var(--border);
    color:#d6d9e0;
  }
  .btn-ghost:hover{background:#0b0d12}

  .qhead{
    display:flex;gap:12px;align-items:flex-start;justify-content:space-between;
    margin-bottom:10px;flex-wrap:wrap;
  }
  .qtitle{margin:0;font-size:18px;line-height:1.25}
  .meta{color:var(--muted);font-size:12px;margin-top:6px}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 8px}
  .options{display:grid;gap:10px;margin-top:10px}
  .opt{
    text-align:left;
    background:#121520;
    border:1px solid var(--border);
    padding:12px 12px;
    border-radius:12px;
  }
  .opt:hover{background:#151a26}
  .opt.correct{background:rgba(31,122,31,.22);border-color:rgba(31,122,31,.6)}
  .opt.wrong{background:rgba(139,30,30,.22);border-color:rgba(139,30,30,.6)}
  .opt:disabled{opacity:.95;cursor:not-allowed}

  .panel{
    margin-top:12px;
    border:1px solid var(--border);
    border-radius:12px;
    padding:12px;
    background:#0b0d12;
    display:none;
  }
  .panel.show{display:block}
  .panel h3{margin:0 0 8px;font-size:14px}
  .hint{border-left:4px solid var(--warn);padding-left:10px;color:#fbe7c2}
  .explain{border-left:4px solid #22c55e;padding-left:10px;color:#c9f7d3}
  .reveal{
    margin-top:10px;
    padding:10px;
    border-radius:12px;
    background:#101423;
    border:1px dashed #394055;
    color:#d7dbe6;
  }
  .footer{
    margin-top:10px;
    display:flex;gap:10px;justify-content:space-between;align-items:center;
    flex-wrap:wrap;
  }
  .progress{color:var(--muted);font-size:12px}
  .big{
    font-size:20px;
    margin:0 0 6px 0;
  }
  .muted{color:var(--muted)}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chip{font-size:12px;color:#d6d9e0;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#0b0d12}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="brand">
      <h1>ğŸ¯ English Trainer</h1>
      <small>Menu por nÃ­veis â€¢ alternativas Aâ€“E â€¢ feedback completo</small>
    </div>
    <div class="pill" id="scorePill">Score: 0 âœ… | 0 âŒ</div>
  </div>

  <!-- HOME -->
  <div id="homeScreen" class="card screen active">
    <p class="big">Escolha um modo</p>
    <p class="muted">Dica: comece pela AvaliaÃ§Ã£o quando for um aluno novo. (vamos montar depois)</p>

    <div class="grid">
      <button class="btn-ghost" onclick="comingSoon()">ğŸ§ª AvaliaÃ§Ã£o (em breve)</button>
      <button class="btn-accent" onclick="startLevel('basic')">ğŸ“˜ BÃ¡sico</button>
      <button onclick="comingSoon()">ğŸ“— PrÃ©-intermediÃ¡rio (em breve)</button>
      <button onclick="comingSoon()">ğŸ“™ IntermediÃ¡rio (em breve)</button>
      <button onclick="comingSoon()">ğŸ“• PrÃ©-avanÃ§ado (em breve)</button>
      <button onclick="comingSoon()">ğŸ† AvanÃ§ado (em breve)</button>
    </div>

    <div class="chips">
      <div class="chip">ğŸ”Š Ãudio em todas</div>
      <div class="chip">ğŸ’¡ Dica sem entregar</div>
      <div class="chip">âœ… ExplicaÃ§Ã£o apÃ³s resposta</div>
      <div class="chip">Aâ€“E embaralhado</div>
    </div>
  </div>

  <!-- QUIZ -->
  <div id="quizScreen" class="card screen">
    <div class="qhead">
      <div>
        <h2 id="prompt" class="qtitle">Carregandoâ€¦</h2>
        <div id="meta" class="meta"></div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn-ghost" onclick="goHome()">âŒ‚ Menu</button>
        <button class="btn-ghost" onclick="resetProgress()">â†» Reset</button>
      </div>
    </div>

    <div class="controls">
      <button class="btn-accent" onclick="playAudio()">ğŸ”Š Ouvir</button>
      <button onclick="toggleHint()">ğŸ’¡ Dica</button>
      <button class="btn-ghost" onclick="repeatSlow()">ğŸ¢ Ouvir devagar</button>
    </div>

    <div id="options" class="options"></div>

    <div id="hintPanel" class="panel">
      <h3>ğŸ’¡ Dica</h3>
      <div id="hintText" class="hint"></div>
    </div>

    <div id="resultPanel" class="panel">
      <h3 id="resultTitle">Resultado</h3>
      <div id="explainText" class="explain"></div>
      <div id="revealBox" class="reveal"></div>
    </div>

    <div class="footer">
      <div class="progress" id="progressText">â€”</div>
      <button id="nextBtn" class="btn-accent" style="display:none" onclick="nextQuestion()">PrÃ³xima â†’</button>
    </div>
  </div>

  <!-- COMPLETE -->
  <div id="completeScreen" class="card screen">
    <p class="big">âœ… Aula concluÃ­da!</p>
    <p class="muted" id="completeSummary">â€”</p>

    <div class="grid" style="margin-top:14px">
      <button class="btn-accent" onclick="startLevel(activeLevel)">ğŸ” Refazer aula</button>
      <button class="btn-ghost" onclick="goHome()">âŒ‚ Voltar ao menu</button>
      <button onclick="comingSoon()">ğŸ“Œ Revisar erros (em breve)</button>
      <button onclick="comingSoon()">â¡ï¸ PrÃ³ximo nÃ­vel (em breve)</button>
    </div>
  </div>
</div>

<!-- SFX -->
<audio id="success">
  <source src="https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3">
</audio>
<audio id="fail">
  <source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.mp3">
</audio>

<script>
/* =========================
   BANCO (por nÃ­veis)
   ========================= */
const BANK = {
  basic: [
    {"id":"B01","type":"PT_to_EN","promptPT":"VocÃª estÃ¡ em uma aula e precisa se apresentar. Qual frase em inglÃªs estÃ¡ correta?","audioTextEN":"I live in SÃ£o Paulo.","options":["I live in SÃ£o Paulo.","I lives in SÃ£o Paulo.","I living in SÃ£o Paulo.","I lived in SÃ£o Paulo."],"correctIndex":0,"hintPT":"Pense: vocÃª estÃ¡ falando do presente (agora) ou do passado?","explainPT":"Com 'I', o verbo fica na forma base no Present Simple (live).","revealEN":"I live in SÃ£o Paulo."},
    {"id":"B02","type":"PickCorrectEN","promptPT":"Seu colega descreve rotina. Qual frase estÃ¡ correta e combina com hÃ¡bito?","audioTextEN":"I usually wake up at six.","options":["I usually wake up at six.","I am usually waking up at six.","I usually waking up at six.","I was usually waking up at six."],"correctIndex":0,"hintPT":"A palavra 'usually' fala de frequÃªncia (rotina), nÃ£o de 'agora'.","explainPT":"AdvÃ©rbios de frequÃªncia (usually/always/sometimes) puxam o Present Simple.","revealEN":"I usually wake up at six."},
    {"id":"B03","type":"PickCorrectEN","promptPT":"VocÃª estÃ¡ descrevendo sua melhor amiga. Escolha a frase correta em inglÃªs.","audioTextEN":"She works as a teacher.","options":["She work as a teacher.","She works as a teacher.","She working as a teacher.","She is work as a teacher."],"correctIndex":1,"hintPT":"Compare com 'I work...'. O que muda com 'She'?","explainPT":"Com he/she/it, geralmente usamos verbo com -s/-es no Present Simple.","revealEN":"She works as a teacher."},
    {"id":"B04","type":"PickCorrectEN","promptPT":"No restaurante, vocÃª quer dizer que nÃ£o bebe cafÃ©. Escolha a frase correta.","audioTextEN":"I do not drink coffee.","options":["I not drink coffee.","I do not drink coffee.","I no drink coffee.","I doesn't drink coffee."],"correctIndex":1,"hintPT":"Na negativa do Present Simple com 'I', vocÃª precisa de um auxiliar.","explainPT":"Negativa: do + not + verbo base (drink).","revealEN":"I do not drink coffee."},
    {"id":"B05","type":"PickCorrectEN","promptPT":"VocÃª quer saber o hobby de alguÃ©m. Qual pergunta estÃ¡ correta?","audioTextEN":"What do you do on weekends?","options":["What you do on weekends?","What do you do on weekends?","What does you do on weekends?","What you doing on weekends?"],"correctIndex":1,"hintPT":"Pergunta no Present Simple geralmente precisa de 'do/does'.","explainPT":"Estrutura: Wh-word + do + subject + verbo base.","revealEN":"What do you do on weekends?"},
    {"id":"B06","type":"PickCorrectEN","promptPT":"VocÃª estÃ¡ falando de algo que vocÃªs fazem juntos no domingo. Qual frase estÃ¡ correta?","audioTextEN":"We cook together on Sundays.","options":["We cooks together on Sundays.","We cook together on Sundays.","We cooking together on Sundays.","We are cook together on Sundays."],"correctIndex":1,"hintPT":"'We' Ã© plural. O verbo costuma ficar na forma base.","explainPT":"Com we/you/they, o verbo fica na forma base no Present Simple.","revealEN":"We cook together on Sundays."},
    {"id":"B07","type":"PickCorrectEN","promptPT":"VocÃª fala sobre seus colegas (eles). Qual frase estÃ¡ correta?","audioTextEN":"They work in the marketing department.","options":["They works in the marketing department.","They working in the marketing department.","They work in the marketing department.","They are work in the marketing department."],"correctIndex":2,"hintPT":"Regra rÃ¡pida: 'they' usa verbo base.","explainPT":"Com they, nada de -s no verbo: they work.","revealEN":"They work in the marketing department."},
    {"id":"B08","type":"PickCorrectEN","promptPT":"VocÃª descreve seu apartamento. Qual frase estÃ¡ correta?","audioTextEN":"It has two bedrooms.","options":["It have two bedrooms.","It has two bedrooms.","It having two bedrooms.","It is have two bedrooms."],"correctIndex":1,"hintPT":"'It' Ã© he/she/it. E 'have' vira 'has'.","explainPT":"Terceira pessoa: it has (forma irregular de have).","revealEN":"It has two bedrooms."},
    {"id":"B09","type":"Audio_to_PT","promptPT":"OuÃ§a a frase e escolha o significado correto (PT).","audioTextEN":"She eats healthy food.","options":["Ela comeu comida saudÃ¡vel ontem.","Ela estÃ¡ comendo comida saudÃ¡vel agora.","Ela come comida saudÃ¡vel.","Ela vai comer comida saudÃ¡vel."],"correctIndex":2,"hintPT":"Sem 'yesterday/now/tomorrow' â†’ pense em rotina/verdade geral.","explainPT":"Present Simple pode indicar hÃ¡bito ou fato geral: 'She eats...'.","revealEN":"She eats healthy food."},
    {"id":"B10","type":"PickCorrectEN","promptPT":"Qual frase fala de hÃ¡bito no presente (rotina)?","audioTextEN":"I study English every day.","options":["I study English every day.","I am studying English every day.","I studied English every day.","I study English yesterday."],"correctIndex":0,"hintPT":"'Every day' indica repetiÃ§Ã£o.","explainPT":"Rotina â†’ Present Simple. 'Yesterday' nÃ£o combina com presente.","revealEN":"I study English every day."},
    {"id":"B11","type":"PickCorrectEN","promptPT":"VocÃª quer perguntar se ele trabalha de manhÃ£. Qual pergunta estÃ¡ correta?","audioTextEN":"Does he work in the morning?","options":["He works in the morning?","Does he work in the morning?","Does he works in the morning?","Work he in the morning?"],"correctIndex":1,"hintPT":"Com he/she/it, perguntas usam 'does'. E o verbo volta Ã  base.","explainPT":"Pergunta: does + sujeito + verbo base (work).","revealEN":"Does he work in the morning?"},
    {"id":"B12","type":"PickCorrectEN","promptPT":"Escolha a forma correta para dizer: 'Ele nÃ£o mora aqui.'","audioTextEN":"He doesn't live here.","options":["He don't live here.","He doesn't live here.","He not live here.","He no live here."],"correctIndex":1,"hintPT":"Com 'he', a negativa usa 'doesn't'.","explainPT":"Doesn't = does not. Depois dele, verbo base: live.","revealEN":"He doesn't live here."},
    {"id":"B13","type":"PickCorrectEN","promptPT":"VocÃª quer saber onde ela trabalha. Qual pergunta estÃ¡ correta?","audioTextEN":"Where does she work?","options":["Where she works?","Where does she work?","Where works she?","Does where she work?"],"correctIndex":1,"hintPT":"Wh-word + auxiliar + sujeito + verbo base.","explainPT":"Em perguntas com Where/What/When: auxiliar vem antes do sujeito.","revealEN":"Where does she work?"},
    {"id":"B14","type":"PickCorrectEN","promptPT":"VocÃª quer saber quando a pessoa costuma chegar. Qual pergunta estÃ¡ correta?","audioTextEN":"When do you usually arrive?","options":["When you usually arrive?","When do you usually arrive?","When does you usually arrive?","When you arrive usually?"],"correctIndex":1,"hintPT":"Com 'you', o auxiliar Ã© 'do'.","explainPT":"Pergunta: When + do + you + verbo base + advÃ©rbio.","revealEN":"When do you usually arrive?"},
    {"id":"B15","type":"PickCorrectEN","promptPT":"Na loja, vocÃª quer perguntar: 'O que Ã© isso em inglÃªs?' Qual frase estÃ¡ correta?","audioTextEN":"What is this in English?","options":["What this is in English?","What is this in English?","What this in English?","What are this in English?"],"correctIndex":1,"hintPT":"Com 'to be', nÃ£o usamos do/does.","explainPT":"Pergunta com 'to be': What + is + sujeito.","revealEN":"What is this in English?"},
    {"id":"B16","type":"PickCorrectEN","promptPT":"VocÃª estÃ¡ dando direÃ§Ã£o ao turista. Qual frase estÃ¡ correta?","audioTextEN":"The museum is next to the park.","options":["The museum next to the park.","The museum are next to the park.","The museum is next to the park.","The museum be next to the park."],"correctIndex":2,"hintPT":"LocalizaÃ§Ã£o quase sempre precisa do verbo 'to be'.","explainPT":"Sujeito singular (museum) â†’ 'is'.","revealEN":"The museum is next to the park."},
    {"id":"B17","type":"PickCorrectEN","promptPT":"VocÃª quer dizer que gosta de pizza. Qual frase estÃ¡ correta?","audioTextEN":"I like pizza.","options":["I liking pizza.","I likes pizza.","I like pizza.","I am like pizza."],"correctIndex":2,"hintPT":"Com 'I', use o verbo base. E 'like' nÃ£o precisa de 'am'.","explainPT":"Present Simple: I like + objeto.","revealEN":"I like pizza."},
    {"id":"B18","type":"PickCorrectEN","promptPT":"VocÃª estÃ¡ preenchendo formulÃ¡rio. Como dizer corretamente: 'Eu trabalho como engenheiro'?","audioTextEN":"I work as an engineer.","options":["I work as engineer.","I working as an engineer.","I work as an engineer.","I works as an engineer."],"correctIndex":2,"hintPT":"Antes de 'engineer', normalmente entra um artigo. E com 'I' o verbo nÃ£o ganha 's'.","explainPT":"Som de vogal em 'engineer' â†’ 'an'. E: I work.","revealEN":"I work as an engineer."},
    {"id":"B19","type":"PickCorrectEN","promptPT":"VocÃª apresenta um amigo francÃªs. Qual frase estÃ¡ correta?","audioTextEN":"He is French.","options":["He French.","He is French.","He are French.","He have French."],"correctIndex":1,"hintPT":"Nacionalidade usa o verbo 'to be'.","explainPT":"Para caracterÃ­sticas/nacionalidade: he is + adjetivo.","revealEN":"He is French."},
    {"id":"B20","type":"PickCorrectEN","promptPT":"Como perguntar com que frequÃªncia a pessoa vai Ã  academia?","audioTextEN":"How often do you go to the gym?","options":["How often you go to the gym?","How often do you go to the gym?","How often does you go to the gym?","How often you do go to the gym?"],"correctIndex":1,"hintPT":"Pergunta de hÃ¡bito com 'you' â†’ usa 'do'.","explainPT":"Estrutura: How often + do + you + verbo base.","revealEN":"How often do you go to the gym?"},
    {"id":"B21","type":"Audio_to_PT","promptPT":"OuÃ§a e escolha o significado correto.","audioTextEN":"She lives in London and works at a bank.","options":["Ela morou em Londres no passado.","Ela estÃ¡ trabalhando em um banco agora.","Ela mora em Londres e trabalha em um banco.","Ela vai morar em Londres em breve."],"correctIndex":2,"hintPT":"Dois verbos no Present Simple â†’ informaÃ§Ãµes atuais/rotina.","explainPT":"Lives/works indicam onde ela mora e trabalha (situaÃ§Ã£o atual).","revealEN":"She lives in London and works at a bank."},
    {"id":"B22","type":"PickCorrectEN","promptPT":"Qual frase indica aÃ§Ã£o acontecendo agora (em progresso)?","audioTextEN":"I am reading a book.","options":["I am reading a book.","I reading a book.","I read a book.","I am read a book."],"correctIndex":0,"hintPT":"AÃ§Ã£o em progresso: 'am/is/are' + verbo com -ing.","explainPT":"Present Continuous: I am + reading.","revealEN":"I am reading a book."},
    {"id":"B23","type":"PickCorrectEN","promptPT":"VocÃª quer saber o preÃ§o de uma camiseta. Qual pergunta estÃ¡ correta?","audioTextEN":"How much is this t-shirt?","options":["How much this t-shirt is?","How much is this t-shirt?","How much cost this t-shirt?","How many is this t-shirt?"],"correctIndex":1,"hintPT":"PreÃ§o: 'How much' + verbo 'to be' invertido.","explainPT":"Pergunta padrÃ£o: How much is/are + item?","revealEN":"How much is this t-shirt?"},
    {"id":"B24","type":"PickCorrectEN","promptPT":"VocÃª quer dizer que ela sabe nadar muito bem. Qual frase estÃ¡ correta?","audioTextEN":"She can swim very well.","options":["She can swim very well.","She can swims very well.","She can swimming very well.","She can is swim very well."],"correctIndex":0,"hintPT":"Depois de 'can', o verbo fica na forma base.","explainPT":"Modal + verbo base: can swim.","revealEN":"She can swim very well."},
    {"id":"B25","type":"PickCorrectEN","promptPT":"Qual frase estÃ¡ 100% correta (negativa + rotina) usando 'they'?","audioTextEN":"They don't work on weekends, but they study English on Saturdays.","options":["They don't work on weekends, but they study English on Saturdays.","They doesn't work on weekends, but they study English on Saturdays.","They don't work on weekends, but they studying English on Saturdays.","They don't works on weekends, but they study English on Saturdays."],"correctIndex":0,"hintPT":"'They' usa 'don't' e verbo base: work/study.","explainPT":"Plural: don't + verbo base. ApÃ³s 'but', a regra continua igual.","revealEN":"They don't work on weekends, but they study English on Saturdays."}
  ]
};

/* =========================
   ESTADO
   ========================= */
let activeLevel = "basic";
let pool = [];            // questÃµes do nÃ­vel (clonadas)
let idx = 0;
let locked = false;
let scoreOk = 0;
let scoreBad = 0;
let rendered = null;      // questÃ£o renderizada (com alternativas embaralhadas)

/* =========================
   ELEMENTOS
   ========================= */
const elScorePill = document.getElementById("scorePill");

const homeScreen = document.getElementById("homeScreen");
const quizScreen = document.getElementById("quizScreen");
const completeScreen = document.getElementById("completeScreen");

const elPrompt = document.getElementById("prompt");
const elMeta = document.getElementById("meta");
const elOptions = document.getElementById("options");

const elHintPanel = document.getElementById("hintPanel");
const elHintText = document.getElementById("hintText");

const elResultPanel = document.getElementById("resultPanel");
const elResultTitle = document.getElementById("resultTitle");
const elExplainText = document.getElementById("explainText");
const elRevealBox = document.getElementById("revealBox");

const elNextBtn = document.getElementById("nextBtn");
const elProgressText = document.getElementById("progressText");

const elCompleteSummary = document.getElementById("completeSummary");

/* =========================
   UTIL
   ========================= */
function updateScorePill(){
  elScorePill.textContent = `Score: ${scoreOk} âœ… | ${scoreBad} âŒ`;
}

function show(screen){
  [homeScreen, quizScreen, completeScreen].forEach(s => s.classList.remove("active"));
  screen.classList.add("active");
}

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function speak(text, rate=0.92){
  if (!("speechSynthesis" in window)) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.rate = rate;
  window.speechSynthesis.speak(u);
}

function playSfx(ok){
  const a = document.getElementById(ok ? "success" : "fail");
  a.currentTime = 0;
  a.play();
}

function shuffle(arr){
  // Fisherâ€“Yates
  for (let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/* =========================
   NORMALIZA + EMBARALHA
   - embaralha opÃ§Ãµes e recalcula correctIndex
   - suporta 4 ou 5 opÃ§Ãµes (Aâ€“E)
   ========================= */
function buildRenderedQuestion(q){
  const opts = q.options.map((text, originalIndex) => ({ text, originalIndex }));
  shuffle(opts);

  const newCorrectIndex = opts.findIndex(o => o.originalIndex === q.correctIndex);

  return {
    ...q,
    options: opts.map(o => o.text),
    correctIndex: newCorrectIndex
  };
}

function optionLabel(i){
  return ["A","B","C","D","E"][i] || String(i+1);
}

/* =========================
   FLOW
   ========================= */
function startLevel(level){
  activeLevel = level;
  pool = structuredClone(BANK[level] || []);
  idx = 0;
  scoreOk = 0;
  scoreBad = 0;
  updateScorePill();
  show(quizScreen);
  loadQuestion();
}

function goHome(){
  show(homeScreen);
}

function resetProgress(){
  if (!confirm("Resetar pontuaÃ§Ã£o e voltar para a primeira questÃ£o deste nÃ­vel?")) return;
  idx = 0;
  scoreOk = 0;
  scoreBad = 0;
  updateScorePill();
  loadQuestion();
}

function comingSoon(){
  alert("ğŸš§ Em breve! Vamos montar a avaliaÃ§Ã£o e os prÃ³ximos nÃ­veis.");
}

/* =========================
   RENDER
   ========================= */
function loadQuestion(){
  locked = false;
  elHintPanel.classList.remove("show");
  elResultPanel.classList.remove("show");
  elNextBtn.style.display = "none";
  elOptions.innerHTML = "";

  if (idx >= pool.length){
    // finished
    elCompleteSummary.textContent =
      `VocÃª concluiu o nÃ­vel ${activeLevel.toUpperCase()}.\nâœ… ${scoreOk} acertos â€¢ âŒ ${scoreBad} erros`;
    show(completeScreen);
    return;
  }

  const q = pool[idx];
  rendered = buildRenderedQuestion(q);

  elPrompt.textContent = rendered.promptPT;
  elMeta.textContent = `QuestÃ£o ${idx+1} / ${pool.length} â€¢ ${rendered.id} â€¢ Tipo: ${rendered.type}`;
  elProgressText.textContent = "Responda. Depois veja a correÃ§Ã£o e clique em PrÃ³xima.";

  elHintText.textContent = rendered.hintPT;

  rendered.options.forEach((opt, i) => {
    const b = document.createElement("button");
    b.className = "opt";
    b.innerHTML = `<strong>${optionLabel(i)})</strong> ${escapeHtml(opt)}`;
    b.onclick = () => choose(i, b);
    elOptions.appendChild(b);
  });
}

function choose(choiceIndex){
  if (locked) return;
  locked = true;

  const q = rendered;
  const isCorrect = choiceIndex === q.correctIndex;

  // mark all
  const btns = [...elOptions.querySelectorAll("button")];
  btns.forEach((b, i) => {
    if (i === q.correctIndex) b.classList.add("correct");
    if (i === choiceIndex && !isCorrect) b.classList.add("wrong");
    b.disabled = true;
  });

  if (isCorrect){ scoreOk++; elResultTitle.textContent = "âœ… Correto!"; }
  else { scoreBad++; elResultTitle.textContent = "âŒ Quase! Vamos corrigir."; }
  updateScorePill();
  playSfx(isCorrect);

  elExplainText.textContent = q.explainPT;
  elRevealBox.innerHTML = `<strong>Frase em inglÃªs (reforÃ§o):</strong><br/>${escapeHtml(q.revealEN)}`;

  elResultPanel.classList.add("show");
  elNextBtn.style.display = "inline-block";
}

function nextQuestion(){
  idx++;
  loadQuestion();
}

function toggleHint(){
  elHintPanel.classList.toggle("show");
}

function playAudio(){
  if (!rendered) return;
  speak(rendered.audioTextEN, 0.92);
}

function repeatSlow(){
  if (!rendered) return;
  speak(rendered.audioTextEN, 0.75);
}

/* start at home */
updateScorePill();
</script>
</body>
</html>