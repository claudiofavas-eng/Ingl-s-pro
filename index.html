<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ingl√™s Pro - Claudio</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;background:#e0e7ff;color:#0f172a}
    .container{max-width:720px;margin:0 auto;padding:18px;min-height:100vh}
    .header{
      background:linear-gradient(135deg,#4f46e5,#2563eb);
      color:#fff;padding:18px;border-radius:20px;margin-bottom:14px;position:relative;
      box-shadow:0 18px 40px rgba(0,0,0,.14);
    }
    .header h1{font-size:1.5em;margin-bottom:6px}
    .header p{opacity:.9}
    .card{
      background:#fff;border-radius:20px;box-shadow:0 14px 30px rgba(0,0,0,.10);
      padding:18px;margin-bottom:14px
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      background:#eef2ff;color:#1e293b;border:1px solid #c7d2fe;border-radius:999px;
      padding:8px 12px;font-weight:700;font-size:.95em
    }
    .btn{
      border:none;border-radius:14px;padding:12px 14px;font-weight:800;cursor:pointer;
      transition:transform .06s ease, filter .2s ease;
      display:inline-flex;align-items:center;justify-content:center;gap:8px
    }
    .btn:active{transform:scale(.98)}
    .btn-primary{background:#4f46e5;color:#fff}
    .btn-ghost{background:#f1f5f9;color:#0f172a}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-success{background:#10b981;color:#fff}
    .btn-warning{background:#f59e0b;color:#111827}
    .btn-wide{width:100%}
    .screen{display:none}
    .screen.active{display:block}

    .level-grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:620px){ .level-grid{grid-template-columns:1fr 1fr} }

    .option{
      border:2px solid #e2e8f0;background:#f8fafc;border-radius:16px;
      padding:12px 12px;cursor:pointer;transition:all .15s ease;display:flex;gap:10px;align-items:flex-start
    }
    .option:hover{filter:brightness(.98)}
    .opt-letter{
      min-width:34px;height:34px;border-radius:12px;background:#e0e7ff;color:#1e293b;
      display:flex;align-items:center;justify-content:center;font-weight:900
    }
    .option.selected{border-color:#4f46e5;background:#eef2ff}
    .option.correct{border-color:#10b981;background:#ecfdf5}
    .option.wrong{border-color:#ef4444;background:#fef2f2}

    .q-title{font-size:1.2em;font-weight:900;margin-bottom:8px}
    .q-sub{color:#475569;margin-bottom:12px;line-height:1.35}
    .divider{height:1px;background:#e5e7eb;margin:14px 0}

    .hintBox{
      background:#fff7ed;border:2px solid #fdba74;border-radius:16px;padding:12px;color:#7c2d12
    }
    .explainBox{
      background:#eff6ff;border:2px solid #93c5fd;border-radius:16px;padding:12px;color:#1e3a8a
    }
    .audioRow{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .tiny{font-size:.92em;color:#64748b}

    .topbar{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin-bottom:10px
    }

    .progressWrap{background:#eef2ff;border-radius:999px;overflow:hidden;height:12px;border:1px solid #c7d2fe}
    .progressBar{height:12px;background:#4f46e5;width:0%}
    .footerActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

    /* Flash feedback */
    .flash{position:fixed;inset:0;pointer-events:none;opacity:0;transition:opacity .18s ease}
    .flash.on{opacity:.18}
    .flash.good{background:#22c55e}
    .flash.bad{background:#ef4444}
  </style>
</head>
<body>
  <div class="flash" id="flash"></div>

  <div class="container">

    <!-- HOME -->
    <div id="homeScreen" class="screen active">
      <div class="header">
        <h1>üéØ Ingl√™s Pro</h1>
        <p>Claudio ‚Ä¢ aula gamificada (B√°sico ‚Üí Pr√©-Intermedi√°rio)</p>
      </div>

      <div class="card">
        <div class="row" style="margin-bottom:10px">
          <div class="pill" id="streakPill">üî• Streak: 0</div>
          <div class="pill" id="xpPill">‚≠ê XP: 0</div>
          <div class="pill" id="accuracyPill">üéØ Acerto: 0%</div>
        </div>

        <div class="level-grid">
          <button class="btn btn-primary btn-wide" onclick="startLevel('basic')">üìò B√°sico (A1)</button>
          <button class="btn btn-primary btn-wide" onclick="startLevel('preintermediate')">üìó Pr√©-Intermedi√°rio (A2)</button>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn btn-ghost" onclick="openStats()">üìä Progresso</button>
          <button class="btn btn-danger" onclick="resetAll()">üß® Resetar tudo</button>
        </div>

        <p class="tiny" style="margin-top:10px">
          Dica: no GitHub Pages, qualquer altera√ß√£o no <strong>index.html</strong> pode levar alguns segundos pra atualizar.
        </p>
      </div>
    </div>

    <!-- STATS -->
    <div id="statsScreen" class="screen">
      <div class="header">
        <h1>üìä Seu Progresso</h1>
        <p>Resumo r√°pido do que voc√™ j√° fez</p>
      </div>

      <div class="card" id="statsBox"></div>

      <div class="card">
        <button class="btn btn-primary btn-wide" onclick="goHome()">‚Üê Voltar</button>
      </div>
    </div>

    <!-- QUIZ -->
    <div id="quizScreen" class="screen">
      <div class="header">
        <h1 id="quizHeader">üß† Aula</h1>
        <p id="quizSub">Responda, pe√ßa dica e ou√ßa o √°udio.</p>
      </div>

      <div class="card">
        <div class="topbar">
          <div style="min-width:220px">
            <div class="tiny" id="qCounter">Quest√£o 1/10</div>
            <div class="progressWrap" aria-label="Progresso">
              <div class="progressBar" id="progressBar"></div>
            </div>
          </div>

          <div class="row">
            <button class="btn btn-ghost" onclick="confirmEndPartial()">‚è∏ Encerrar parcial</button>
            <button class="btn btn-danger" onclick="confirmExitHome()">üè† In√≠cio</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="q-title" id="qTitle">Carregando‚Ä¶</div>
        <div class="q-sub" id="qPrompt"></div>

        <div class="audioRow">
          <button class="btn btn-ghost" onclick="speakCurrent(0.9)">üîä Ouvir</button>
          <button class="btn btn-ghost" onclick="speakCurrent(0.75)">üê¢ Ouvir devagar</button>
        </div>

        <div id="optionsBox" style="display:grid;gap:10px"></div>

        <div class="footerActions">
          <button class="btn btn-warning" onclick="toggleHint()">üí° Dica</button>
          <button class="btn btn-primary" id="checkBtn" onclick="checkAnswer()">‚úÖ Verificar</button>
          <button class="btn btn-primary" id="nextBtn" style="display:none" onclick="nextQuestion()">‚û°Ô∏è Pr√≥xima</button>
        </div>

        <div id="hintArea" style="display:none;margin-top:12px" class="hintBox"></div>
        <div id="explainArea" style="display:none;margin-top:12px" class="explainBox"></div>

        <p class="tiny" style="margin-top:12px" id="tipFooter"></p>
      </div>
    </div>

  </div>

<script>
/* =========================
   0) UTIL / STORAGE
========================= */
const STORE_KEY = "inglesPro_v3";
const nowISO = () => new Date().toISOString();
const todayKey = () => new Date().toLocaleDateString("pt-BR");

function loadState(){
  try{
    return JSON.parse(localStorage.getItem(STORE_KEY) || "{}");
  }catch(e){
    return {};
  }
}
function saveState(patch){
  const s = loadState();
  const merged = { ...s, ...patch };
  localStorage.setItem(STORE_KEY, JSON.stringify(merged));
  return merged;
}

function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

function shuffle(arr){
  // Fisher-Yates (in-place copy)
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/* =========================
   1) BANCO DE QUEST√ïES
   (B√°sico + Pr√©-Intermedi√°rio)
========================= */
const BANK = {
  basic: [
    {
      id:"B01",
      promptPT:"Escolha a frase correta para o ambiente de trabalho.",
      audioTextEN:"I help my team.",
      options:[
        "I help my team.",
        "I helps my team.",
        "I helping my team.",
        "I helped my team every day.",
        "I am help my team."
      ],
      correctIndex:0,
      hintPT:"Observe quem faz a a√ß√£o (I / he / she / they).",
      explainPT:"Com I, o verbo fica na forma base (help), sem ‚Äús‚Äù."
    },
    {
      id:"B02",
      promptPT:"O que essa frase significa?",
      audioTextEN:"I wake up early.",
      options:[
        "Eu acordo cedo.",
        "Eu acordei cedo ontem.",
        "Eu estou acordando agora.",
        "Eu vou acordar cedo amanh√£.",
        "Eu estava acordando cedo."
      ],
      correctIndex:0,
      hintPT:"A frase fala de h√°bito ou de um momento espec√≠fico?",
      explainPT:"Presente simples geralmente indica rotina/h√°bito."
    },
    {
      id:"B03",
      promptPT:"Voc√™ est√° viajando. Qual frase faz sentido?",
      audioTextEN:"I go to the airport.",
      options:[
        "I go to the airport.",
        "I goes to the airport.",
        "I going to the airport.",
        "I went go to the airport.",
        "I am go to the airport."
      ],
      correctIndex:0,
      hintPT:"Com I, qual forma do verbo usamos?",
      explainPT:"I + verbo base (go)."
    },
    {
      id:"B04",
      promptPT:"Complete a frase.",
      audioTextEN:"At school, I study English.",
      options:[
        "study",
        "studies",
        "studying",
        "studied",
        "studyed"
      ],
      correctIndex:0,
      hintPT:"Pense em algo que voc√™ faz com frequ√™ncia.",
      explainPT:"A√ß√£o habitual ‚Üí Present Simple (study)."
    },
    {
      id:"B05",
      promptPT:"Qual frase combina com cinema?",
      audioTextEN:"I like this movie.",
      options:[
        "Eu gosto desse filme.",
        "Eu estou fazendo um filme.",
        "Eu gostei desse filme ontem.",
        "Eu vou gostar desse filme amanh√£.",
        "Eu estou gostando desse filme agora."
      ],
      correctIndex:0,
      hintPT:"‚ÄòLike‚Äô aqui √© prefer√™ncia geral.",
      explainPT:"Like no presente indica gosto/prefer√™ncia."
    },
    {
      id:"B06",
      promptPT:"Escolha a frase correta.",
      audioTextEN:"She works at the office.",
      options:[
        "She work at the office.",
        "She works at the office.",
        "She working at the office.",
        "She worked at the office every day.",
        "She is work at the office."
      ],
      correctIndex:1,
      hintPT:"Observe o sujeito: √© I ou she?",
      explainPT:"He/She/It ‚Üí verbo recebe ‚Äús‚Äù (works)."
    },
    {
      id:"B07",
      promptPT:"Qual frase fala de algo que voc√™ faz sempre?",
      audioTextEN:"I watch movies on weekends.",
      options:[
        "I watch movies on weekends.",
        "I am watching a movie now.",
        "I watched a movie yesterday.",
        "I will watch a movie tomorrow.",
        "I watching movies on weekends."
      ],
      correctIndex:0,
      hintPT:"On weekends indica rotina.",
      explainPT:"Presente simples + rotina."
    },
    {
      id:"B08",
      promptPT:"Escolha a frase mais natural.",
      audioTextEN:"I have coffee in the morning.",
      options:[
        "I have coffee in the morning.",
        "I am have coffee in the morning.",
        "I having coffee in the morning.",
        "I having coffee every morning.",
        "I have coffees in the morning."
      ],
      correctIndex:0,
      hintPT:"Veja qual frase soa natural e completa.",
      explainPT:"Estrutura simples do Present Simple."
    },
    {
      id:"B09",
      promptPT:"O que essa frase quer dizer?",
      audioTextEN:"I am from Brazil.",
      options:[
        "Eu sou do Brasil.",
        "Eu estou no Brasil agora.",
        "Eu vou para o Brasil.",
        "Eu gosto do Brasil.",
        "Eu moro no Brasil."
      ],
      correctIndex:0,
      hintPT:"From indica origem.",
      explainPT:"I am from‚Ä¶ = eu sou de / eu venho de."
    },
    {
      id:"B10",
      promptPT:"Qual frase fala de rotina no trabalho?",
      audioTextEN:"I check my emails every morning.",
      options:[
        "I check my emails every morning.",
        "I am checking my emails now.",
        "I checked my emails yesterday.",
        "I will check my emails tomorrow.",
        "I checking my emails every morning."
      ],
      correctIndex:0,
      hintPT:"Every morning indica h√°bito.",
      explainPT:"Present Simple + rotina."
    },
    {
      id:"B11",
      promptPT:"Escolha a frase correta para descrever rotina dos seus pais.",
      audioTextEN:"They live in a big house.",
      options:[
        "They lives in a big house.",
        "They live in a big house.",
        "They living in a big house.",
        "They lived in a big house now.",
        "They are live in a big house."
      ],
      correctIndex:1,
      hintPT:"They √© plural. Plural leva 's' no verbo?",
      explainPT:"Com They (plural), verbo fica na base (live)."
    },
    {
      id:"B12",
      promptPT:"Complete a frase.",
      audioTextEN:"We go to the park on Sundays.",
      options:[
        "go",
        "goes",
        "going",
        "went",
        "gone"
      ],
      correctIndex:0,
      hintPT:"We = n√≥s. Verbo fica como no I.",
      explainPT:"We + verbo base (go)."
    },
    {
      id:"B13",
      promptPT:"Como voc√™ diz que n√£o gosta de caf√©?",
      audioTextEN:"I do not like coffee.",
      options:[
        "I not like coffee.",
        "I do not like coffee.",
        "I no like coffee.",
        "I am not like coffee.",
        "I don't likes coffee."
      ],
      correctIndex:1,
      hintPT:"Negativa no presente usa do/does.",
      explainPT:"I do not (don‚Äôt) + verbo base."
    },
    {
      id:"B14",
      promptPT:"Escolha a frase correta para dizer que ele n√£o trabalha no s√°bado.",
      audioTextEN:"He does not work on Saturday.",
      options:[
        "He do not works on Saturday.",
        "He does not work on Saturday.",
        "He not works on Saturday.",
        "He does not works on Saturday.",
        "He doesn't works on Saturday."
      ],
      correctIndex:1,
      hintPT:"O 's' vai no auxiliar ou no verbo?",
      explainPT:"Does + verbo base (work), sem 's' no verbo."
    },
    {
      id:"B15",
      promptPT:"Como voc√™ pergunta se a pessoa estuda ingl√™s?",
      audioTextEN:"Do you study English?",
      options:[
        "You study English?",
        "Are you study English?",
        "Do you study English?",
        "Does you study English?",
        "Do you studies English?"
      ],
      correctIndex:2,
      hintPT:"Pergunta no presente: do/does + sujeito + verbo base.",
      explainPT:"Com You usamos DO."
    }
  ],

  preintermediate: [
    {
      id:"P01",
      promptPT:"Voc√™ est√° falando do que est√° acontecendo AGORA. Qual frase est√° correta?",
      audioTextEN:"I am studying right now.",
      options:["I am studying right now.","I study right now.","I studying right now.","I am study right now.","I studied right now."],
      correctIndex:0,
      hintPT:"Procure um sinal de 'agora': right now/at the moment/now.",
      explainPT:"A√ß√£o em progresso: am/is/are + verbo com -ing."
    },
    {
      id:"P02",
      promptPT:"Rotina/h√°bito. Qual frase est√° correta?",
      audioTextEN:"I study English every day.",
      options:["I am studying English every day.","I study English every day.","I studies English every day.","I studying English every day.","I study English yesterday."],
      correctIndex:1,
      hintPT:"Every day = h√°bito.",
      explainPT:"H√°bito ‚Üí Present Simple."
    },
    {
      id:"P03",
      promptPT:"Voc√™ quer dizer que N√ÉO tem tempo hoje. Qual frase est√° correta?",
      audioTextEN:"I don't have time today.",
      options:["I no have time today.","I don't have time today.","I doesn't have time today.","I am not have time today.","I not have time today."],
      correctIndex:1,
      hintPT:"Negativa no Present Simple precisa de auxiliar (do/does).",
      explainPT:"Com I/you/we/they: don't + verbo base."
    },
    {
      id:"P04",
      promptPT:"Qual pergunta est√° correta para perguntar ONDE fica o banheiro?",
      audioTextEN:"Where is the bathroom?",
      options:["Where the bathroom is?","Where is the bathroom?","Where does the bathroom is?","Where are the bathroom?","Where is bathroom?"],
      correctIndex:1,
      hintPT:"Com 'to be' (is/are) n√£o usamos do/does.",
      explainPT:"Where + is/are + sujeito."
    },
    {
      id:"P05",
      promptPT:"Viagem: pedir a conta de forma educada. Qual frase √© melhor?",
      audioTextEN:"Could I have the bill, please?",
      options:["Could I have the bill, please?","Can I to have the bill, please?","Could I has the bill, please?","I have the bill, please?","Do you have bill?"],
      correctIndex:0,
      hintPT:"Pedido educado: Could I‚Ä¶? (sem 'to' antes do verbo).",
      explainPT:"Depois de could/can, verbo fica na base."
    },
    {
      id:"P06",
      promptPT:"Voc√™ quer dizer que foi ao cinema ontem. Qual frase est√° correta?",
      audioTextEN:"I went to the cinema yesterday.",
      options:["I go to the cinema yesterday.","I went to the cinema yesterday.","I goed to the cinema yesterday.","I was go to the cinema yesterday.","I am going to the cinema yesterday."],
      correctIndex:1,
      hintPT:"Yesterday = passado ‚Üí Past Simple.",
      explainPT:"Past Simple de go √© irregular: went."
    },
    {
      id:"P07",
      promptPT:"Voc√™ quer dizer que j√° terminou a tarefa. Qual frase est√° correta?",
      audioTextEN:"I finished my homework.",
      options:["I finish my homework.","I finished my homework.","I finishing my homework.","I have finish my homework.","I was finished my homework."],
      correctIndex:1,
      hintPT:"A√ß√£o conclu√≠da no passado (mesmo que recente).",
      explainPT:"Finished = Past Simple."
    },
    {
      id:"P08",
      promptPT:"Futuro planejado (inten√ß√£o). Qual frase est√° correta?",
      audioTextEN:"I'm going to travel next month.",
      options:["I going to travel next month.","I'm going to travel next month.","I will to travel next month.","I'm go travel next month.","I traveled next month."],
      correctIndex:1,
      hintPT:"Plano: be + going to + verbo base.",
      explainPT:"I'm going to + verb."
    },
    {
      id:"P09",
      promptPT:"Comparativo: sua casa √© maior que a minha. Qual frase est√° correta?",
      audioTextEN:"Your house is bigger than mine.",
      options:["Your house is more big than mine.","Your house is bigger than mine.","Your house are bigger than mine.","Your house is big than mine.","Your house is biggest than mine."],
      correctIndex:1,
      hintPT:"Adjetivo curto: big ‚Üí bigger.",
      explainPT:"bigger + than."
    },
    {
      id:"P10",
      promptPT:"Quantidades: voc√™ precisa comprar p√£o. Qual frase √© correta?",
      audioTextEN:"I need some bread.",
      options:["I need some bread.","I need a bread.","I need many bread.","I need breads.","I need few bread."],
      correctIndex:0,
      hintPT:"Bread √© incont√°vel.",
      explainPT:"Incont√°vel: some bread."
    },
    {
      id:"P11",
      promptPT:"Pre√ßo: qual pergunta est√° correta?",
      audioTextEN:"How much does it cost?",
      options:["How much it costs?","How much does it cost?","How much do it cost?","How much does it costs?","How many does it cost?"],
      correctIndex:1,
      hintPT:"Pergunta com it (singular) usa does + verbo base.",
      explainPT:"Does + cost (base)."
    },
    {
      id:"P12",
      promptPT:"Voc√™ quer dizer: 'Ela n√£o gosta de acordar cedo'. Qual frase correta?",
      audioTextEN:"She doesn't like waking up early.",
      options:["She don't like waking up early.","She doesn't likes waking up early.","She doesn't like waking up early.","She not like waking up early.","She isn't like waking up early."],
      correctIndex:2,
      hintPT:"Com she/he/it: doesn't + verbo base.",
      explainPT:"Doesn't + like (base)."
    },
    {
      id:"P13",
      promptPT:"There is/are: escolha a frase correta.",
      audioTextEN:"There are two chairs in the room.",
      options:["There is two chairs in the room.","There are two chairs in the room.","There have two chairs in the room.","It are two chairs in the room.","There are two chair in the room."],
      correctIndex:1,
      hintPT:"Plural ‚Üí are.",
      explainPT:"Two chairs = plural ‚Üí there are."
    },
    {
      id:"P14",
      promptPT:"Cont√°vel: qual frase est√° correta?",
      audioTextEN:"I have a few friends in this city.",
      options:["I have a few friends in this city.","I have a little friends in this city.","I have few friend in this city.","I have much friends in this city.","I have many friend in this city."],
      correctIndex:0,
      hintPT:"Friends √© cont√°vel/plural.",
      explainPT:"Countable plural: a few friends."
    },
    {
      id:"P15",
      promptPT:"Incont√°vel: qual frase est√° correta?",
      audioTextEN:"I have a little time today.",
      options:["I have a little time today.","I have a few time today.","I have many time today.","I have a time today.","I have much times today."],
      correctIndex:0,
      hintPT:"Time √© incont√°vel.",
      explainPT:"Uncountable: a little time."
    }
    // (Se quiser, eu adiciono j√° o pacote 40/80/120 do pr√©-intermedi√°rio no pr√≥ximo envio)
  ]
};

/* =========================
   2) CONFIG / SESS√ÉO
========================= */
const LETTERS = ["A","B","C","D","E"];

let session = {
  levelKey: null,
  originalBank: [],
  remaining: [],
  askedCount: 0,
  targetCount: 12, // quantas quest√µes por aula (pode ajustar)
  current: null,
  currentShuffledOptions: [],
  correctText: "",
  selectedIndex: null,
  locked: false,
  usedHint: false,
  correct: 0,
  wrong: 0
};

/* =========================
   3) UI HELPERS
========================= */
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function goHome(){
  renderHomePills();
  showScreen("homeScreen");
}

function openStats(){
  const s = loadState();
  const statsBox = document.getElementById("statsBox");
  const basic = s.basic || {};
  const pre = s.preintermediate || {};
  statsBox.innerHTML = `
    <div class="row" style="margin-bottom:12px">
      <div class="pill">üî• Streak: ${s.streak||0}</div>
      <div class="pill">‚≠ê XP: ${s.xp||0}</div>
      <div class="pill">üéØ Acerto: ${calcAccuracy(s)}%</div>
    </div>

    <div class="divider"></div>

    <p style="font-weight:900;margin-bottom:6px">üìò B√°sico</p>
    <p class="tiny">Conclu√≠das: <strong>${(basic.completedSessions||0)}</strong> ‚Ä¢ Melhor acerto: <strong>${(basic.bestAcc||0)}%</strong></p>

    <div class="divider"></div>

    <p style="font-weight:900;margin-bottom:6px">üìó Pr√©-Intermedi√°rio</p>
    <p class="tiny">Conclu√≠das: <strong>${(pre.completedSessions||0)}</strong> ‚Ä¢ Melhor acerto: <strong>${(pre.bestAcc||0)}%</strong></p>

    <div class="divider"></div>

    <p class="tiny">Dica: Se quiser, eu adiciono ‚Äúteste de n√≠vel‚Äù e trilha autom√°tica (A1‚ÜíA2‚ÜíB1‚Ä¶).</p>
  `;
  showScreen("statsScreen");
}

function calcAccuracy(state){
  const c = state.totalCorrect||0;
  const w = state.totalWrong||0;
  const t = c+w;
  return t ? Math.round((c/t)*100) : 0;
}

function renderHomePills(){
  const s = loadState();
  document.getElementById("streakPill").textContent = `üî• Streak: ${s.streak||0}`;
  document.getElementById("xpPill").textContent = `‚≠ê XP: ${s.xp||0}`;
  document.getElementById("accuracyPill").textContent = `üéØ Acerto: ${calcAccuracy(s)}%`;
}

/* =========================
   4) AUDIO (TTS)
========================= */
function speak(text, rate=0.9){
  if(!("speechSynthesis" in window)) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "en-US";
  u.rate = rate;
  speechSynthesis.speak(u);
}
function speakCurrent(rate){
  if(!session.current) return;
  speak(session.current.audioTextEN, rate);
}

/* =========================
   5) FEEDBACK SOUNDS
========================= */
let audioCtx = null;
function beep(type){
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const ctx = audioCtx;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);

    const t0 = ctx.currentTime;
    if(type==="good"){
      o.type = "sine";
      o.frequency.setValueAtTime(880, t0);
      o.frequency.exponentialRampToValueAtTime(1320, t0+0.08);
      g.gain.setValueAtTime(0.001, t0);
      g.gain.exponentialRampToValueAtTime(0.12, t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.001, t0+0.18);
      o.start(t0); o.stop(t0+0.20);
    }else{
      o.type = "square";
      o.frequency.setValueAtTime(220, t0);
      o.frequency.exponentialRampToValueAtTime(110, t0+0.10);
      g.gain.setValueAtTime(0.001, t0);
      g.gain.exponentialRampToValueAtTime(0.16, t0+0.01);
      g.gain.exponentialRampToValueAtTime(0.001, t0+0.22);
      o.start(t0); o.stop(t0+0.24);
    }
  }catch(e){}
}

function flash(type){
  const el = document.getElementById("flash");
  el.className = "flash " + (type==="good" ? "good" : "bad");
  requestAnimationFrame(()=> el.classList.add("on"));
  setTimeout(()=> el.classList.remove("on"), 160);
}

/* =========================
   6) CORE: START / LOAD Q
========================= */
function startLevel(levelKey){
  const bank = BANK[levelKey];
  if(!bank || !bank.length){
    alert("Esse n√≠vel ainda n√£o tem quest√µes.");
    return;
  }

  session.levelKey = levelKey;
  session.originalBank = bank.slice();
  session.remaining = shuffle(bank); // embaralha ordem das quest√µes
  session.askedCount = 0;
  session.targetCount = levelKey==="basic" ? 12 : 12; // pode ajustar por n√≠vel
  session.current = null;
  session.currentShuffledOptions = [];
  session.correctText = "";
  session.selectedIndex = null;
  session.locked = false;
  session.usedHint = false;
  session.correct = 0;
  session.wrong = 0;

  document.getElementById("quizHeader").textContent =
    levelKey==="basic" ? "üìò B√°sico (A1)" : "üìó Pr√©-Intermedi√°rio (A2)";

  document.getElementById("quizSub").textContent =
    "Escolha uma alternativa. Use dica e √°udio quando precisar.";

  nextQuestion(true);
  showScreen("quizScreen");
}

function pickNextQuestion(){
  // Se acabou, reembaralha e continua (para ter banco grande e sem travar)
  if(session.remaining.length === 0){
    session.remaining = shuffle(session.originalBank);
  }
  return session.remaining.pop();
}

function buildShuffledQuestion(q){
  // embaralha op√ß√µes e recalcula √≠ndice correto
  const correctText = q.options[q.correctIndex];
  const shuffled = shuffle(q.options);

  // garante varia√ß√£o boa: se por acaso cair sempre A, a chance √© baixa,
  // mas aqui refor√ßamos com um "re-shuffle" quando cai em A repetido muito.
  // (Simpl√£o: se correto cair em A 3x seguidas, reembaralha)
  // Vamos manter um hist√≥rico por sess√£o.
  if(!session._lastCorrectLetters) session._lastCorrectLetters = [];
  let idx = shuffled.indexOf(correctText);
  let letter = LETTERS[idx] || "A";
  const last = session._lastCorrectLetters.slice(-2);
  if(last.length===2 && last[0]===letter && last[1]===letter){
    // reembaralha uma vez pra tentar mudar
    const resh = shuffle(q.options);
    const idx2 = resh.indexOf(correctText);
    shuffled.splice(0, shuffled.length, ...resh);
    idx = idx2;
    letter = LETTERS[idx] || "A";
  }
  session._lastCorrectLetters.push(letter);

  return {
    ...q,
    _correctText: correctText,
    _shuffledOptions: shuffled
  };
}

/* =========================
   7) RENDER
========================= */
function renderQuestion(){
  const q = session.current;
  const optionsBox = document.getElementById("optionsBox");

  document.getElementById("hintArea").style.display = "none";
  document.getElementById("explainArea").style.display = "none";
  document.getElementById("checkBtn").style.display = "inline-flex";
  document.getElementById("nextBtn").style.display = "none";
  session.selectedIndex = null;
  session.locked = false;
  session.usedHint = false;

  const total = session.targetCount;
  const n = clamp(session.askedCount, 1, total);
  document.getElementById("qCounter").textContent = `Quest√£o ${n}/${total}`;
  document.getElementById("progressBar").style.width = `${Math.round((n-1)/total*100)}%`;

  document.getElementById("qTitle").textContent = `üéØ ${q.promptPT}`;
  document.getElementById("qPrompt").textContent = "Escolha a melhor alternativa:";

  // Observa√ß√£o pequena com a letra correta (para debug interno) ‚Äî DESLIGADO:
  document.getElementById("tipFooter").textContent =
    `Tema: ${session.levelKey} ‚Ä¢ Use üîä pra ouvir a frase em ingl√™s.`;

  optionsBox.innerHTML = "";
  q._shuffledOptions.forEach((text, idx)=>{
    const div = document.createElement("div");
    div.className = "option";
    div.onclick = ()=> selectOption(idx);

    const letter = LETTERS[idx] || "?";
    div.innerHTML = `
      <div class="opt-letter">${letter}</div>
      <div style="flex:1">
        <div style="font-weight:900">${text}</div>
      </div>
    `;
    optionsBox.appendChild(div);
  });
}

function selectOption(idx){
  if(session.locked) return;
  session.selectedIndex = idx;
  const children = [...document.getElementById("optionsBox").children];
  children.forEach((c,i)=>{
    c.classList.toggle("selected", i===idx);
  });
}

function toggleHint(){
  if(!session.current) return;
  session.usedHint = true;
  const hintArea = document.getElementById("hintArea");
  hintArea.innerHTML = `<strong>üí° Dica:</strong> ${session.current.hintPT || "Observe o padr√£o da frase."}`;
  hintArea.style.display = "block";
}

/* =========================
   8) CHECK / NEXT / END
========================= */
function checkAnswer(){
  if(session.locked) return;

  if(session.selectedIndex===null){
    alert("Selecione uma alternativa primeiro üòâ");
    return;
  }

  session.locked = true;

  const q = session.current;
  const correctText = q._correctText;
  const chosenText = q._shuffledOptions[session.selectedIndex];
  const isCorrect = chosenText === correctText;

  const optionsEls = [...document.getElementById("optionsBox").children];
  optionsEls.forEach((el, idx)=>{
    const t = q._shuffledOptions[idx];
    if(t === correctText) el.classList.add("correct");
    if(idx === session.selectedIndex && !isCorrect) el.classList.add("wrong");
  });

  const explain = document.getElementById("explainArea");
  explain.innerHTML = `
    <div style="font-weight:900;margin-bottom:6px">${isCorrect ? "‚úÖ Correto!" : "‚ùå Quase!"}</div>
    <div class="tiny" style="margin-bottom:8px"><strong>Frase (EN):</strong> ${q.audioTextEN}</div>
    <div><strong>Por qu√™:</strong> ${q.explainPT || "Boa! Continue observando o padr√£o."}</div>
  `;
  explain.style.display = "block";

  // feedback audiovisual
  if(isCorrect){
    session.correct++;
    beep("good"); flash("good");
  }else{
    session.wrong++;
    beep("bad"); flash("bad");
  }

  // XP e stats globais
  const s = loadState();
  const addXP = isCorrect ? 10 : 2;
  const totalCorrect = (s.totalCorrect||0) + (isCorrect?1:0);
  const totalWrong = (s.totalWrong||0) + (isCorrect?0:1);
  let xp = (s.xp||0) + addXP;

  saveState({ xp, totalCorrect, totalWrong });

  document.getElementById("checkBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "inline-flex";

  // Se errou: para ficar ‚Äúdin√¢mico‚Äù, j√° prepara um ‚Äúrecurso‚Äù:
  // na pr√≥xima, prioriza outra quest√£o (n√£o repete a mesma).
}

function nextQuestion(isFirst=false){
  // Se j√° completou a meta, encerra
  if(!isFirst && session.askedCount >= session.targetCount){
    finishSession();
    return;
  }

  // se errou na √∫ltima, aumenta chance de puxar outra do mesmo n√≠vel (j√° √©)
  const qRaw = pickNextQuestion();
  const q = buildShuffledQuestion(qRaw);

  session.current = q;
  session.askedCount = session.askedCount + 1;

  renderQuestion();

  // fala autom√°tico s√≥ na primeira quest√£o (pra n√£o ficar chato)
  if(isFirst){
    setTimeout(()=> speakCurrent(0.9), 250);
  }
}

function finishSession(){
  // Atualiza streak (s√≥ se ainda n√£o marcou hoje)
  const s = loadState();
  const lastDay = s.lastDay || null;
  const today = todayKey();
  let streak = s.streak || 0;

  if(lastDay !== today){
    // se foi ‚Äúontem‚Äù ou qualquer outro, a gente incrementa
    // (simples: incrementa sempre que for novo dia)
    streak = streak + 1;
  }

  // accuracy da sess√£o
  const total = session.correct + session.wrong;
  const acc = total ? Math.round((session.correct/total)*100) : 0;

  // stats por n√≠vel
  const level = s[session.levelKey] || {};
  const completedSessions = (level.completedSessions||0) + 1;
  const bestAcc = Math.max(level.bestAcc||0, acc);

  saveState({
    streak,
    lastDay: today,
    [session.levelKey]: { ...level, completedSessions, bestAcc }
  });

  alert(`‚úÖ Aula conclu√≠da!\n\nAcerto: ${acc}%\nCertas: ${session.correct}\nErradas: ${session.wrong}\nXP ganho: +${session.correct*10 + session.wrong*2}`);

  goHome();
}

function confirmExitHome(){
  const ok = confirm("Quer voltar ao in√≠cio agora? (o progresso parcial desta aula fica salvo s√≥ no geral, mas a aula atual reinicia)");
  if(ok) goHome();
}

function confirmEndPartial(){
  const ok = confirm("Encerrar parcial e voltar ao in√≠cio?");
  if(ok){
    // n√£o conta como sess√£o conclu√≠da, mas mant√©m XP j√° ganho
    goHome();
  }
}

function resetAll(){
  const ok = confirm("Tem certeza que quer resetar TUDO? (XP, streak, progresso)");
  if(!ok) return;
  localStorage.removeItem(STORE_KEY);
  renderHomePills();
  alert("Resetado ‚úÖ");
}

/* =========================
   INIT
========================= */
renderHomePills();
</script>
</body>
</html>